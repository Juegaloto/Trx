<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Inversión TRX</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos existentes (mantenidos) */
        :root {
            --primary: #ff6b00;
            --primary-dark: #e55a00;
            --secondary: #34a853;
            --secondary-dark: #2d9246;
            --danger: #ea4335;
            --danger-dark: #d33426;
            --warning: #ffa726;
            --dark: #202124;
            --light: #f8f9fa;
            --gray: #5f6368;
            --gray-light: #f0f0f0;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #ff8c00, #ff6b00);
            color: var(--dark);
            line-height: 1.6;
            font-size: 14px;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }
        
        /* Header y Navegación */
        header {
            background-color: rgba(255, 255, 255, 0.85);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .logo i {
            margin-right: 8px;
            font-size: 1.5rem;
        }
        
        .nav-links {
            display: flex;
            list-style: none;
        }
        
        .nav-links li {
            margin-left: 20px;
        }
        
        .nav-links a {
            text-decoration: none;
            color: var(--dark);
            font-weight: 500;
            transition: var(--transition);
            font-size: 0.9rem;
            padding: 6px 0;
            position: relative;
        }
        
        .nav-links a:hover {
            color: var(--primary);
        }
        
        .nav-links a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--primary);
            transition: var(--transition);
        }
        
        .nav-links a:hover::after {
            width: 100%;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
        }
        
        .user-info {
            margin-right: 12px;
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #ff8c00);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
            font-size: 0.9rem;
        }
        
        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 107, 0, 0.3);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: var(--secondary-dark);
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: var(--danger-dark);
            transform: translateY(-2px);
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }
        
        /* Menú lateral */
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            transition: left 0.3s ease;
            z-index: 200;
            padding: 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        .sidebar.active {
            left: 0;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .close-sidebar {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--gray);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .close-sidebar:hover {
            background-color: var(--gray-light);
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 8px;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            text-decoration: none;
            color: var(--dark);
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-size: 0.9rem;
        }
        
        .sidebar-menu a:hover {
            background-color: var(--gray-light);
            transform: translateX(4px);
        }
        
        .sidebar-menu i {
            margin-right: 10px;
            width: 18px;
            text-align: center;
            font-size: 1rem;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 150;
            display: none;
            backdrop-filter: blur(4px);
        }
        
        .overlay.active {
            display: block;
        }
        
        /* Contenido principal */
        .main-content {
            padding: 24px 0;
            min-height: calc(100vh - 80px);
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 18px;
            margin-bottom: 28px;
        }
        
        .card {
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.03);
            backdrop-filter: blur(5px);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }
        
        .card-title {
            font-size: 0.9rem;
            color: var(--gray);
            font-weight: 500;
        }
        
        .card-icon {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }
        
        .card-icon.primary {
            background: linear-gradient(135deg, var(--primary), #ff8c00);
        }
        
        .card-icon.secondary {
            background: linear-gradient(135deg, var(--secondary), #34a853);
        }
        
        .card-icon.warning {
            background: linear-gradient(135deg, var(--warning), #ff9800);
        }
        
        .card-icon.danger {
            background: linear-gradient(135deg, var(--danger), #d93025);
        }
        
        .card-value {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 6px;
            color: var(--dark);
        }
        
        .card-description {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        .section {
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 22px;
            margin-bottom: 28px;
            border: 1px solid rgba(0, 0, 0, 0.03);
            backdrop-filter: blur(5px);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 14px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        /* Formularios */
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: var(--transition);
            background-color: rgba(255, 255, 255, 0.7);
        }
        
        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(255, 107, 0, 0.1);
        }
        
        .form-text {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 6px;
        }
        
        /* Tablas */
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th, .table td {
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
            font-size: 0.85rem;
        }
        
        .table th {
            font-weight: 600;
            color: var(--gray);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .table tbody tr:hover {
            background-color: rgba(249, 249, 249, 0.7);
        }
        
        .status {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            gap: 4px;
        }
        
        .status.active {
            background-color: #e6f4ea;
            color: var(--secondary);
        }
        
        .status.pending {
            background-color: #fef7e0;
            color: var(--warning);
        }
        
        .status.completed {
            background-color: #e6f4ea;
            color: var(--secondary);
        }
        
        .status.cancelled {
            background-color: #fce8e6;
            color: var(--danger);
        }
        
        /* Modales */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            backdrop-filter: blur(4px);
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            padding: 24px;
            transform: translateY(-20px);
            transition: transform 0.3s;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            max-height: 90vh;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 14px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--gray);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .close-modal:hover {
            background-color: var(--gray-light);
        }
        
        /* Páginas de autenticación */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary), #ff8c00);
            padding: 20px;
        }
        
        .auth-card {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            width: 90%;
            max-width: 420px;
            padding: 28px;
            backdrop-filter: blur(10px);
        }
        
        .auth-header {
            text-align: center;
            margin-bottom: 28px;
        }
        
        .auth-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        .auth-subtitle {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        .auth-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
        }
        
        .auth-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .auth-link:hover {
            text-decoration: underline;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .table-responsive {
                overflow-x: auto;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .section-title {
                font-size: 1.1rem;
            }
            
            .card-value {
                font-size: 1.4rem;
            }
            
            .modal-content {
                width: 95%;
                padding: 18px;
            }
            
            .investment-details {
                grid-template-columns: 1fr;
            }
            
            .investment-actions {
                flex-direction: column;
            }
            
            .transaction-filters {
                flex-wrap: wrap;
                gap: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 12px;
            }
            
            .main-content {
                padding: 16px 0;
            }
            
            .section {
                padding: 18px;
            }
            
            .auth-card {
                padding: 22px;
            }
            
            .btn {
                padding: 8px 14px;
                font-size: 0.85rem;
            }
            
            .card {
                padding: 16px;
            }
        }
        
        /* Utilidades */
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .mb-3 {
            margin-bottom: 16px;
        }
        
        .mt-3 {
            margin-top: 16px;
        }
        
        .d-none {
            display: none !important;
        }
        
        .d-block {
            display: block;
        }
        
        .d-flex {
            display: flex;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .align-center {
            align-items: center;
        }
        
        .w-100 {
            width: 100%;
        }
        
        .alert {
            padding: 12px 14px;
            border-radius: var(--border-radius);
            margin-bottom: 18px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.9rem;
        }
        
        .alert-success {
            background-color: #e6f4ea;
            color: var(--secondary);
            border: 1px solid #c4e6d4;
        }
        
        .alert-danger {
            background-color: #fce8e6;
            color: var(--danger);
            border: 1px solid #f5c2c7;
        }
        
        .alert-warning {
            background-color: #fef7e0;
            color: var(--warning);
            border: 1px solid #fae8b3;
        }
        
        .alert-info {
            background-color: #e8f4fd;
            color: #1a73e8;
            border: 1px solid #bbdefb;
        }
        
        .referral-code {
            background-color: var(--gray-light);
            padding: 12px 14px;
            border-radius: var(--border-radius);
            font-family: monospace;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .copy-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
        }
        
        .copy-btn:hover {
            background-color: rgba(255, 107, 0, 0.1);
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-primary {
            background-color: rgba(255, 107, 0, 0.1);
            color: var(--primary);
        }
        
        .badge-secondary {
            background-color: rgba(52, 168, 83, 0.1);
            color: var(--secondary);
        }
        
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease forwards;
        }
        
        /* Scroll personalizado */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* Estilos para inversiones activas modernas */
        .investment-card {
            background: linear-gradient(135deg, rgba(245, 247, 250, 0.8) 0%, rgba(255, 255, 255, 0.9) 100%);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 0, 0, 0.03);
            transition: var(--transition);
            backdrop-filter: blur(5px);
        }
        
        .investment-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        
        .investment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .investment-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        .investment-plan {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            background-color: rgba(255, 107, 0, 0.1);
            color: var(--primary);
        }
        
        .investment-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .investment-detail {
            text-align: center;
        }
        
        .investment-detail-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .investment-detail-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .investment-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.8rem;
        }
        
        .btn-disabled {
            background-color: var(--gray-light);
            color: var(--gray);
            cursor: not-allowed;
        }
        
        .btn-disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Estilos para el botón de nueva inversión */
        .new-investment-btn {
            background: linear-gradient(135deg, var(--primary), #ff8c00);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 24px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
        }
        
        .new-investment-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 107, 0, 0.4);
        }
        
        /* Estilos para el modal de detalles de inversión */
        .investment-detail-modal .modal-content {
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .investment-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-item {
            padding: 12px;
            background-color: rgba(248, 249, 250, 0.7);
            border-radius: var(--border-radius);
        }
        
        .info-label {
            font-size: 0.8rem;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        /* Estilos para las transacciones en el historial */
        .transaction-positive {
            color: var(--secondary);
            font-weight: 600;
        }
        
        .transaction-negative {
            color: var(--danger);
            font-weight: 600;
        }
        
        .transaction-type {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .transaction-type.deposit {
            background-color: rgba(52, 168, 83, 0.1);
            color: var(--secondary);
        }
        
        .transaction-type.withdrawal {
            background-color: rgba(234, 67, 53, 0.1);
            color: var(--danger);
        }
        
        .transaction-type.investment {
            background-color: rgba(255, 107, 0, 0.1);
            color: var(--primary);
        }
        
        .transaction-type.earning {
            background-color: rgba(255, 167, 38, 0.1);
            color: var(--warning);
        }
        
        /* Filtros de transacciones */
        .transaction-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        /* Sistema de notificaciones moderno */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }
        
        .notification {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            border-left: 4px solid var(--primary);
            backdrop-filter: blur(5px);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.hide {
            transform: translateX(400px);
        }
        
        .notification.success {
            border-left-color: var(--secondary);
        }
        
        .notification.error {
            border-left-color: var(--danger);
        }
        
        .notification.warning {
            border-left-color: var(--warning);
        }
        
        .notification-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            flex-shrink: 0;
        }
        
        .notification.success .notification-icon {
            background-color: var(--secondary);
        }
        
        .notification.error .notification-icon {
            background-color: var(--danger);
        }
        
        .notification.warning .notification-icon {
            background-color: var(--warning);
        }
        
        .notification.info .notification-icon {
            background-color: var(--primary);
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }
        
        .notification-message {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        .notification-close {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
            flex-shrink: 0;
        }
        
        .notification-close:hover {
            background-color: var(--gray-light);
        }
        
        /* Diálogos de confirmación */
        .confirmation-dialog .modal-content {
            max-width: 400px;
            text-align: center;
        }
        
        .confirmation-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            font-size: 1.5rem;
            color: white;
        }
        
        .confirmation-icon.warning {
            background-color: var(--warning);
        }
        
        .confirmation-icon.danger {
            background-color: var(--danger);
        }
        
        .confirmation-icon.success {
            background-color: var(--secondary);
        }
        
        .confirmation-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }
        
        .confirmation-actions .btn {
            flex: 1;
        }
        
        /* Gap utility */
        .gap-2 {
            gap: 8px;
        }
        
        /* Botón de actualizar página */
        .refresh-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        
        .refresh-btn:hover {
            background-color: var(--primary-dark);
            transform: rotate(180deg);
            box-shadow: 0 6px 15px rgba(255, 107, 0, 0.4);
        }
        
        /* Estilos para el pico de piedra */
        .rock-peak {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
        
        .rock-icon {
            font-size: 3rem;
            color: #8B4513;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }
        
        .rock-icon:hover {
            transform: scale(1.1);
        }
        
        .day-counter {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--dark);
            background: rgba(255, 255, 255, 0.7);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* Estilos para enlaces de contacto */
        .contact-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }
        
        .contact-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: var(--border-radius);
            text-decoration: none;
            color: var(--dark);
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .contact-link:hover {
            background-color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .contact-link i {
            font-size: 1.2rem;
            color: var(--primary);
        }
        
        .contact-link.support i {
            color: #0088cc;
        }
        
        .contact-link.info i {
            color: var(--secondary);
        }
        
        /* Estilos para balance bloqueado */
        .locked-balance {
            background-color: #fef7e0;
            border-left: 4px solid var(--warning);
            padding: 12px 15px;
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .locked-balance i {
            color: var(--warning);
            font-size: 1.2rem;
        }
        
        .locked-balance-text {
            flex: 1;
        }
        
        .locked-balance-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .locked-balance-description {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        /* Estilos para la lista de referidos jerárquica */
        .referral-tree {
            margin-top: 20px;
        }
        
        .referral-level {
            margin-bottom: 20px;
        }
        
        .level-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .level-badge {
            background-color: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        
        .referral-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 12px;
        }
        
        .referral-item {
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: var(--border-radius);
            padding: 15px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }
        
        .referral-item:hover {
            background-color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .referral-user {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .referral-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), #ff8c00);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .referral-info {
            flex: 1;
        }
        
        .referral-name {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .referral-date {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .referral-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.85rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 8px;
            background-color: rgba(248, 249, 250, 0.7);
            border-radius: var(--border-radius);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--gray);
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-weight: 600;
            color: var(--dark);
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--gray-light);
        }
        
        .loading-state {
            text-align: center;
            padding: 30px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 107, 0, 0.2);
            border-left: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos para el sistema de referidos CORREGIDOS */
        .referral-system-info {
            margin-top: 8px;
        }

        .level-info {
            margin-top: 10px;
        }

        .level-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .level-bullet {
            color: var(--primary);
            font-weight: bold;
            margin-right: 8px;
            margin-top: 2px;
            flex-shrink: 0;
        }

        .level-content {
            flex: 1;
        }

        .level-content strong {
            color: var(--dark);
        }

        /* ESTILOS PARA EL TORNEO DE MINERÍA PvP */
        .tournament-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            margin-top: 20px;
        }

        .game-area {
            background: rgba(0, 0, 0, 0.7);
            border-radius: var(--border-radius);
            padding: 20px;
            min-height: 500px;
            position: relative;
            overflow: hidden;
        }

        .game-map {
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #1a3c34, #2d5a4e);
            border-radius: var(--border-radius);
            position: relative;
            overflow: hidden;
        }

        .player {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .player.me {
            border: 3px solid #ffeb3b;
            box-shadow: 0 0 10px #ffeb3b;
        }

        .upgrade {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            animation: pulse 2s infinite;
            cursor: pointer;
            z-index: 5;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .upgrade.nft {
            background: linear-gradient(135deg, #9c27b0, #673ab7);
        }

        .upgrade.gpu {
            background: linear-gradient(135deg, #2196f3, #03a9f4);
        }

        .upgrade.energy {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
        }

        .game-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .game-info {
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--border-radius);
            padding: 20px;
        }

        .ranking-list {
            margin-top: 15px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--gray-light);
        }

        .ranking-position {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }

        .ranking-position.top3 {
            background: var(--secondary);
        }

        .ranking-details {
            flex: 1;
        }

        .ranking-name {
            font-weight: 600;
        }

        .ranking-trx {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .puzzle-modal .modal-content {
            max-width: 400px;
            text-align: center;
        }

        .puzzle-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin: 20px 0;
        }

        .puzzle-piece {
            width: 80px;
            height: 80px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .puzzle-piece:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .mining-rig {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: var(--border-radius);
        }

        .rig-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rig-info {
            flex: 1;
        }

        .rig-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .rig-stats {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
        }

        .tournament-card {
            background: linear-gradient(135deg, #1a3c34, #2d5a4e);
            color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .tournament-card h3 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .tournament-prize {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffeb3b;
            margin: 10px 0;
        }

        .tournament-timer {
            font-size: 1.2rem;
            font-weight: bold;
            margin: 10px 0;
            color: #4caf50;
        }

        .tournament-participants {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .participant {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }

        .tournament-status {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-top: 10px;
            display: inline-block;
        }

        .status-joining {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .status-active {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .status-finished {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }
    </style>
</head>
<body>
    <!-- Botón de actualizar página -->
    <button class="refresh-btn" id="refreshPage">
        <i class="fas fa-sync-alt"></i>
    </button>
    
    <!-- Sistema de Notificaciones -->
    <div class="notification-container" id="notificationContainer"></div>
    
    <!-- Overlay para el menú lateral -->
    <div class="overlay" id="overlay"></div>
    
    <!-- Menú lateral -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">Menú Principal</div>
            <button class="close-sidebar" id="closeSidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" data-page="dashboard"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="#" data-page="invest"><i class="fas fa-chart-line"></i> Invertir</a></li>
            <li><a href="#" data-page="deposit"><i class="fas fa-wallet"></i> Depositar</a></li>
            <li><a href="#" data-page="withdraw"><i class="fas fa-money-bill-wave"></i> Retirar</a></li>
            <li><a href="#" data-page="referrals"><i class="fas fa-users"></i> Referidos</a></li>
            <li><a href="#" data-page="tournament"><i class="fas fa-trophy"></i> Torneo PvP</a></li>
            <li><a href="#" data-page="history"><i class="fas fa-history"></i> Historial</a></li>
            <li><a href="#" data-page="profile"><i class="fas fa-user"></i> Perfil</a></li>
            <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Cerrar Sesión</a></li>
        </ul>
        
        <!-- Sección de Contacto -->
        <div class="contact-links">
            <a href="https://t.me/+2vdtNnTh-nIzZDkx" target="_blank" class="contact-link support">
                <i class="fab fa-telegram"></i>
                <div>
                    <strong>Soporte</strong>
                    <div class="form-text">Contacta con nuestro equipo de soporte</div>
                </div>
            </a>
            <a href="https://t.me/+sOSTR7_4AoYwMjY5" target="_blank" class="contact-link info">
                <i class="fab fa-telegram"></i>
                <div>
                    <strong>Canal de Información</strong>
                    <div class="form-text">Mantente informado con nuestras actualizaciones</div>
                </div>
            </a>
        </div>
    </div>
    
    <!-- Header -->
    <header>
        <div class="container">
            <div class="navbar">
                <div class="logo">
                    <i class="fas fa-coins"></i>
                    <span>TRX Investment</span>
                </div>
                <ul class="nav-links">
                    <li><a href="#" data-page="dashboard">Dashboard</a></li>
                    <li><a href="#" data-page="invest">Invertir</a></li>
                    <li><a href="#" data-page="deposit">Depositar</a></li>
                    <li><a href="#" data-page="withdraw">Retirar</a></li>
                    <li><a href="#" data-page="referrals">Referidos</a></li>
                    <li><a href="#" data-page="tournament">Torneo PvP</a></li>
                </ul>
                <div class="user-menu">
                    <div class="user-info" id="userInfo">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <span id="userName">Usuario</span>
                    </div>
                    <button class="btn btn-primary" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Contenido principal -->
    <div class="main-content">
        <div class="container">
            <!-- Página de Dashboard -->
            <div id="dashboard-page" class="page fade-in">
                <h1 class="mb-3">Dashboard</h1>
                
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Balance Total</div>
                            <div class="card-icon primary">
                                <i class="fas fa-wallet"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalBalance">0 TRX</div>
                        <div class="card-description">Saldo disponible + inversiones activas</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Ganancias Totales</div>
                            <div class="card-icon secondary">
                                <i class="fas fa-chart-line"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalEarnings">0 TRX</div>
                        <div class="card-description">Ganancias acumuladas</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Inversiones Activas</div>
                            <div class="card-icon warning">
                                <i class="fas fa-cube"></i>
                            </div>
                        </div>
                        <div class="card-value" id="activeInvestments">0</div>
                        <div class="card-description">Máquinas mineras activas</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Referidos</div>
                            <div class="card-icon danger">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="card-value" id="totalReferrals">0</div>
                        <div class="card-description">Usuarios referidos</div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Inversiones Activas</div>
                        <button class="new-investment-btn" data-page="invest">
                            <i class="fas fa-plus"></i> Nueva Inversión
                        </button>
                    </div>
                    <div id="activeInvestmentsContainer">
                        <!-- Aquí se cargarán las inversiones activas con diseño moderno -->
                        <div class="text-center" id="investmentsLoading">
                            <p>Cargando inversiones...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Sección de Contacto en Dashboard -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Contacto y Soporte</div>
                    </div>
                    <div class="contact-links">
                        <a href="https://t.me/+2vdtNnTh-nIzZDkx" target="_blank" class="contact-link support">
                            <i class="fab fa-telegram"></i>
                            <div>
                                <strong>Soporte Técnico</strong>
                                <div class="form-text">¿Tienes problemas? Contacta con nuestro equipo de soporte</div>
                            </div>
                        </a>
                        <a href="https://t.me/+sOSTR7_4AoYwMjY5" target="_blank" class="contact-link info">
                            <i class="fab fa-telegram"></i>
                            <div>
                                <strong>Canal de Información</strong>
                                <div class="form-text">Mantente informado con nuestras últimas actualizaciones</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Página de Inversión -->
            <div id="invest-page" class="page d-none">
                <h1 class="mb-3">Realizar Inversión</h1>
                
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Planes de Inversión</div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i> Todos los planes pagan un 3% diario durante 15 días (45% de retorno total).
                    </div>
                    
                    <div class="dashboard-cards">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Plan Básico</div>
                                <div class="card-icon primary">
                                    <i class="fas fa-cube"></i>
                                </div>
                            </div>
                            <div class="card-value">30 - 100 TRX</div>
                            <div class="card-description">3% diario por 15 días</div>
                            <button class="btn btn-primary mt-3" data-plan="basic">
                                <i class="fas fa-check"></i> Seleccionar
                            </button>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Plan Avanzado</div>
                                <div class="card-icon secondary">
                                    <i class="fas fa-cubes"></i>
                                </div>
                            </div>
                            <div class="card-value">101 - 300 TRX</div>
                            <div class="card-description">3% diario por 15 días</div>
                            <button class="btn btn-primary mt-3" data-plan="advanced">
                                <i class="fas fa-check"></i> Seleccionar
                            </button>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Plan Premium</div>
                                <div class="card-icon warning">
                                    <i class="fas fa-gem"></i>
                                </div>
                            </div>
                            <div class="card-value">301 - 500 TRX</div>
                            <div class="card-description">3% diario por 15 días</div>
                            <button class="btn btn-primary mt-3" data-plan="premium">
                                <i class="fas fa-check"></i> Seleccionar
                            </button>
                        </div>
                        
                        <!-- NUEVOS PLANES DE INVERSIÓN -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Plan Pro</div>
                                <div class="card-icon primary">
                                    <i class="fas fa-rocket"></i>
                                </div>
                            </div>
                            <div class="card-value">501 - 1000 TRX</div>
                            <div class="card-description">3.5% diario por 15 días</div>
                            <button class="btn btn-primary mt-3" data-plan="pro">
                                <i class="fas fa-check"></i> Seleccionar
                            </button>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Plan VIP</div>
                                <div class="card-icon secondary">
                                    <i class="fas fa-crown"></i>
                                </div>
                            </div>
                            <div class="card-value">1001 - 2000 TRX</div>
                            <div class="card-description">4% diario por 15 días</div>
                            <button class="btn btn-primary mt-3" data-plan="vip">
                                <i class="fas fa-check"></i> Seleccionar
                            </button>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Plan Elite</div>
                                <div class="card-icon warning">
                                    <i class="fas fa-star"></i>
                                </div>
                            </div>
                            <div class="card-value">2001 - 5000 TRX</div>
                            <div class="card-description">5% diario por 15 días</div>
                            <button class="btn btn-primary mt-3" data-plan="elite">
                                <i class="fas fa-check"></i> Seleccionar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="section d-none" id="investmentForm">
                    <div class="section-header">
                        <div class="section-title">Confirmar Inversión</div>
                    </div>
                    
                    <form id="investForm">
                        <div class="form-group">
                            <label class="form-label">Plan seleccionado</label>
                            <input type="text" class="form-control" id="selectedPlan" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Monto a invertir (TRX)</label>
                            <input type="number" class="form-control" id="investmentAmount" min="30" max="5000" required>
                            <div class="form-text">El monto debe estar entre 30 y 5000 TRX según el plan seleccionado.</div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Ganancia esperada</label>
                            <input type="text" class="form-control" id="expectedEarnings" readonly>
                            <div class="form-text" id="expectedEarningsText">3% diario durante 15 días (45% de retorno total).</div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-check-circle"></i> Confirmar Inversión
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Página de Depósito -->
            <div id="deposit-page" class="page d-none">
                <h1 class="mb-3">Realizar Depósito</h1>
                
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Información de Depósito</div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i> Los depósitos se procesan manualmente. Por favor, envíe exactamente la cantidad que desea depositar a la dirección proporcionada.
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Dirección TRX para depósito</label>
                        <div class="referral-code">
                            <span id="depositAddress">TRvzJ5gtskxSEH3kaQGbkVxsmo7afiu7Dm</span>
                            <button class="copy-btn" data-target="depositAddress">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="form-text">Esta es su dirección personal para depósitos. No envíe otras criptomonedas a esta dirección.</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Monto a depositar (TRX)</label>
                        <input type="number" class="form-control" id="depositAmount" min="10" required>
                        <div class="form-text">El depósito mínimo es de 10 TRX.</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Hash de transacción (Opcional)</label>
                        <input type="text" class="form-control" id="transactionHash" placeholder="Ingrese el hash de su transacción para verificación más rápida">
                    </div>
                    
                    <button class="btn btn-primary w-100" id="submitDeposit">
                        <i class="fas fa-paper-plane"></i> Solicitar Depósito
                    </button>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Historial de Depósitos</div>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Monto</th>
                                    <th>Hash</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="depositsTable">
                                <tr>
                                    <td colspan="4" class="text-center">Cargando depósitos...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Página de Retiro -->
            <div id="withdraw-page" class="page d-none">
                <h1 class="mb-3">Solicitar Retiro</h1>
                
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Información de Retiro</div>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-info-circle"></i> Los retiros se procesan dentro de las 24 horas. El monto mínimo de retiro es de 5 TRX.
                    </div>
                    
                    <!-- Sección de Balance Bloqueado -->
                    <div id="lockedBalanceSection" class="locked-balance d-none">
                        <i class="fas fa-lock"></i>
                        <div class="locked-balance-text">
                            <div class="locked-balance-title">Balance Bloqueado</div>
                            <div class="locked-balance-description">
                                Tienes <span id="lockedBalanceAmount">10 TRX</span> bloqueados que no puedes retirar hasta que realices tu primera inversión.
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Saldo disponible</label>
                        <input type="text" class="form-control" id="availableBalance" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Dirección TRX para retiro</label>
                        <input type="text" class="form-control" id="withdrawAddress" placeholder="Ingrese su dirección TRX" required>
                        <div class="form-text">Asegúrese de que la dirección sea correcta. No nos hacemos responsables por fondos enviados a direcciones incorrectas.</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Monto a retirar (TRX)</label>
                        <input type="number" class="form-control" id="withdrawAmount" min="5" required>
                        <div class="form-text">El retiro mínimo es de 5 TRX.</div>
                    </div>
                    
                    <button class="btn btn-primary w-100" id="submitWithdraw">
                        <i class="fas fa-paper-plane"></i> Solicitar Retiro
                    </button>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Historial de Retiros</div>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Monto</th>
                                    <th>Dirección</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawalsTable">
                                <tr>
                                    <td colspan="4" class="text-center">Cargando retiros...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Página de Referidos - VERSIÓN ACTUALIZADA CON 3 NIVELES Y CORREGIDA -->
            <div id="referrals-page" class="page d-none">
                <h1 class="mb-3">Sistema de Referidos</h1>
                
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Tu Código de Referido</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Comparte este código con tus amigos</label>
                        <div class="referral-code">
                            <span id="referralCode">CARGANDO...</span>
                            <button class="copy-btn" data-target="referralCode">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="form-text">Gana 0.1 TRX por cada usuario que invite y comisiones por sus inversiones.</div>
                    </div>
                    
                    <!-- ENLACE DEL BOT DE TELEGRAM COMO ÚNICO ENLACE DE INVITACIÓN -->
                    <div class="form-group">
                        <label class="form-label">Tu enlace de invitación</label>
                        <div class="referral-code">
                            <span id="referralLink">https://t.me/TRXInvestment12_bot?start=</span>
                            <button class="copy-btn" data-target="referralLink">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="form-text">Comparte este enlace del bot de Telegram con tu código de referido para invitar a más personas.</div>
                    </div>
                </div>
                
                <!-- NUEVA SECCIÓN: ÁRBOL DE REFERIDOS JERÁRQUICO -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Tu Red de Referidos</div>
                    </div>
                    
                    <div id="referralTreeContainer">
                        <div class="loading-state">
                            <div class="spinner"></div>
                            <p>Cargando tu red de referidos...</p>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Ganancias por Referidos</div>
                    </div>
                    
                    <!-- Información sobre el sistema de 3 niveles CORREGIDA -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        <div class="referral-system-info">
                            <strong>Sistema de Referidos de 3 Niveles:</strong>
                            <div class="level-info">
                                <div class="level-item">
                                    <span class="level-bullet">•</span>
                                    <div class="level-content">
                                        <strong>Nivel 1:</strong> 0.1 TRX por cada usuario que invites + 10% de comisión por sus inversiones
                                    </div>
                                </div>
                                <div class="level-item">
                                    <span class="level-bullet">•</span>
                                    <div class="level-content">
                                        <strong>Nivel 2:</strong> 5% de comisión por las inversiones de los referidos de tus referidos
                                    </div>
                                </div>
                                <div class="level-item">
                                    <span class="level-bullet">•</span>
                                    <div class="level-content">
                                        <strong>Nivel 3:</strong> 2% de comisión por las inversiones de los referidos del nivel 2
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3 TARJETAS PARA GANANCIAS POR REFERIDOS -->
                    <div class="dashboard-cards">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Comisiones Totales</div>
                                <div class="card-icon primary">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                            </div>
                            <div class="card-value" id="totalCommissions">0 TRX</div>
                            <div class="card-description">
                                <div>Nivel 1: <span id="level1Commissions">0 TRX</span></div>
                                <div>Nivel 2: <span id="level2Commissions">0 TRX</span></div>
                                <div>Nivel 3: <span id="level3Commissions">0 TRX</span></div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Comisiones Disponibles</div>
                                <div class="card-icon secondary">
                                    <i class="fas fa-wallet"></i>
                                </div>
                            </div>
                            <div class="card-value" id="availableCommissions">0 TRX</div>
                            <div class="card-description">Listas para retirar</div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Ganancias por Referido</div>
                                <div class="card-icon warning">
                                    <i class="fas fa-user-plus"></i>
                                </div>
                            </div>
                            <div class="card-value" id="referralEarnings">0 TRX</div>
                            <div class="card-description">0.1 TRX por cada referido directo</div>
                        </div>
                    </div>
                    
                    <!-- Sección para reclamar ganancias por referidos -->
                    <div class="mt-3">
                        <button class="btn btn-primary" id="claimReferralEarnings">
                            <i class="fas fa-coins"></i> Reclamar Ganancias por Referidos
                        </button>
                        <div class="form-text mt-2">
                            Puedes reclamar 0.1 TRX por cada referido cada 24 horas, de lunes a viernes.
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Página de Torneo PvP -->
            <div id="tournament-page" class="page d-none">
                <h1 class="mb-3">Torneo del Pool de Minería (PvP)</h1>
                
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Torneos Disponibles</div>
                    </div>
                    
                    <div class="dashboard-cards">
                        <div class="tournament-card">
                            <h3>Torneo de 4 Jugadores</h3>
                            <div class="tournament-prize">Premio: 40 TRX</div>
                            <div class="tournament-timer">Entrada: 10 Hash Points</div>
                            <div class="tournament-participants">
                                <div class="participant">1</div>
                                <div class="participant">2</div>
                                <div class="participant">3</div>
                                <div class="participant empty">?</div>
                            </div>
                            <div class="tournament-status status-joining">Uniéndose</div>
                            <button class="btn btn-primary mt-3 join-tournament" data-size="4">
                                <i class="fas fa-play"></i> Unirse al Torneo
                            </button>
                        </div>
                        
                        <div class="tournament-card">
                            <h3>Torneo de 8 Jugadores</h3>
                            <div class="tournament-prize">Premio: 80 TRX</div>
                            <div class="tournament-timer">Entrada: 20 Hash Points</div>
                            <div class="tournament-participants">
                                <div class="participant">1</div>
                                <div class="participant">2</div>
                                <div class="participant">3</div>
                                <div class="participant">4</div>
                                <div class="participant">5</div>
                                <div class="participant empty">?</div>
                                <div class="participant empty">?</div>
                                <div class="participant empty">?</div>
                            </div>
                            <div class="tournament-status status-joining">Uniéndose</div>
                            <button class="btn btn-primary mt-3 join-tournament" data-size="8">
                                <i class="fas fa-play"></i> Unirse al Torneo
                            </button>
                        </div>
                        
                        <div class="tournament-card">
                            <h3>Torneo de 16 Jugadores</h3>
                            <div class="tournament-prize">Premio: 160 TRX</div>
                            <div class="tournament-timer">Entrada: 40 Hash Points</div>
                            <div class="tournament-participants">
                                <div class="participant">1</div>
                                <div class="participant">2</div>
                                <div class="participant">3</div>
                                <div class="participant">4</div>
                                <div class="participant">5</div>
                                <div class="participant">6</div>
                                <div class="participant">7</div>
                                <div class="participant">8</div>
                                <div class="participant empty">?</div>
                                <div class="participant empty">?</div>
                                <div class="participant empty">?</div>
                                <div class="participant empty">?</div>
                                <div class="participant empty">?</div>
                                <div class="participant empty">?</div>
                                <div class="participant empty">?</div>
                                <div class="participant empty">?</div>
                            </div>
                            <div class="tournament-status status-joining">Uniéndose</div>
                            <button class="btn btn-primary mt-3 join-tournament" data-size="16">
                                <i class="fas fa-play"></i> Unirse al Torneo
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="section d-none" id="activeTournamentSection">
                    <div class="section-header">
                        <div class="section-title">Torneo en Curso</div>
                        <div class="tournament-timer" id="tournamentTimer">05:00</div>
                    </div>
                    
                    <div class="tournament-container">
                        <div class="game-area">
                            <div class="game-map" id="gameMap">
                                <!-- Aquí se renderizarán los jugadores y mejoras -->
                            </div>
                            <div class="game-controls">
                                <button class="btn btn-primary" id="moveUp">
                                    <i class="fas fa-arrow-up"></i> Arriba
                                </button>
                                <button class="btn btn-primary" id="moveDown">
                                    <i class="fas fa-arrow-down"></i> Abajo
                                </button>
                                <button class="btn btn-primary" id="moveLeft">
                                    <i class="fas fa-arrow-left"></i> Izquierda
                                </button>
                                <button class="btn btn-primary" id="moveRight">
                                    <i class="fas fa-arrow-right"></i> Derecha
                                </button>
                            </div>
                        </div>
                        
                        <div class="game-info">
                            <h3>Tu Equipo de Minería</h3>
                            <div class="mining-rig">
                                <div class="rig-icon">
                                    <i class="fas fa-microchip"></i>
                                </div>
                                <div class="rig-info">
                                    <div class="rig-name">Rig Básico</div>
                                    <div class="rig-stats">
                                        <div>Hash Rate: <span id="hashRate">10 H/s</span></div>
                                        <div>TRX Minado: <span id="minedTRX">0</span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <h3 class="mt-3">Ranking</h3>
                            <div class="ranking-list" id="rankingList">
                                <!-- Aquí se mostrará el ranking de jugadores -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Página de Historial -->
            <div id="history-page" class="page d-none">
                <h1 class="mb-3">Historial de Transacciones</h1>
                
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Todas las Transacciones</div>
                        <div class="transaction-filters">
                            <button class="btn btn-primary btn-small" id="filterAll">Todas</button>
                            <button class="btn btn-outline btn-small" id="filterDeposits">Depósitos</button>
                            <button class="btn btn-outline btn-small" id="filterWithdrawals">Retiros</button>
                            <button class="btn btn-outline btn-small" id="filterInvestments">Inversiones</button>
                            <button class="btn btn-outline btn-small" id="filterEarnings">Ganancias</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Descripción</th>
                                    <th>Monto</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="transactionsTable">
                                <tr>
                                    <td colspan="5" class="text-center">Cargando transacciones...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Página de Perfil -->
            <div id="profile-page" class="page d-none">
                <h1 class="mb-3">Mi Perfil</h1>
                
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Información Personal</div>
                    </div>
                    
                    <form id="profileForm">
                        <div class="form-group">
                            <label class="form-label">Nombre de Usuario</label>
                            <input type="text" class="form-control" id="profileUsername" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Correo Electrónico</label>
                            <input type="email" class="form-control" id="profileEmail" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Fecha de Registro</label>
                            <input type="text" class="form-control" id="profileRegistrationDate" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Código de Referido (Opcional)</label>
                            <input type="text" class="form-control" id="profileReferralCode" placeholder="Si te refirió alguien, ingresa su código aquí">
                        </div>
                    </form>
                </div>
                
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Cambiar Contraseña</div>
                    </div>
                    
                    <form id="passwordForm">
                        <div class="form-group">
                            <label class="form-label">Contraseña Actual</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Nueva Contraseña</label>
                            <input type="password" class="form-control" id="newPassword" minlength="6" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Confirmar Nueva Contraseña</label>
                            <input type="password" class="form-control" id="confirmPassword" minlength="6" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-key"></i> Cambiar Contraseña
                        </button>
                    </form>
                </div>
                
                <!-- Sección de Contacto en Perfil -->
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Contacto y Soporte</div>
                    </div>
                    <div class="contact-links">
                        <a href="https://t.me/+2vdtNnTh-nIzZDkx" target="_blank" class="contact-link support">
                            <i class="fab fa-telegram"></i>
                            <div>
                                <strong>Soporte Técnico</strong>
                                <div class="form-text">¿Tienes problemas? Contacta con nuestro equipo de soporte</div>
                            </div>
                        </a>
                        <a href="https://t.me/+sOSTR7_4AoYwMjY5" target="_blank" class="contact-link info">
                            <i class="fab fa-telegram"></i>
                            <div>
                                <strong>Canal de Información</strong>
                                <div class="form-text">Mantente informado con nuestras últimas actualizaciones</div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modales de Autenticación -->
    <div class="auth-container d-none" id="auth-container">
        <div class="auth-card">
            <!-- Modal de Registro -->
            <div id="register-modal" class="auth-modal">
                <div class="auth-header">
                    <div class="auth-title">Crear Cuenta</div>
                    <div class="auth-subtitle">Regístrate para comenzar a invertir</div>
                </div>
                
                <form id="registerForm">
                    <div class="form-group">
                        <label class="form-label">Nombre de Usuario</label>
                        <input type="text" class="form-control" id="registerUsername" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Correo Electrónico</label>
                        <input type="email" class="form-control" id="registerEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="registerPassword" minlength="6" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Confirmar Contraseña</label>
                        <input type="password" class="form-control" id="registerConfirmPassword" minlength="6" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Código de Referido (Obligatorio)</label>
                        <input type="text" class="form-control" id="registerReferralCode" placeholder="Ingresa el código de referido" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">Registrarse</button>
                </form>
                
                <div class="auth-footer">
                    ¿Ya tienes una cuenta? <a href="#" class="auth-link" id="showLogin">Iniciar Sesión</a>
                </div>
            </div>
            
            <!-- Modal de Inicio de Sesión -->
            <div id="login-modal" class="auth-modal d-none">
                <div class="auth-header">
                    <div class="auth-title">Iniciar Sesión</div>
                    <div class="auth-subtitle">Accede a tu cuenta</div>
                </div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Correo Electrónico</label>
                        <input type="email" class="form-control" id="loginEmail" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">Iniciar Sesión</button>
                </form>
                
                <div class="auth-footer">
                    <div class="mb-3">
                        ¿Olvidaste tu contraseña? <a href="#" class="auth-link" id="showForgotPassword">Recuperar</a>
                    </div>
                    ¿No tienes una cuenta? <a href="#" class="auth-link" id="showRegister">Regístrate</a>
                </div>
            </div>
            
            <!-- Modal de Recuperación de Contraseña -->
            <div id="forgot-password-modal" class="auth-modal d-none">
                <div class="auth-header">
                    <div class="auth-title">Recuperar Contraseña</div>
                    <div class="auth-subtitle">Te enviaremos un enlace para restablecer tu contraseña</div>
                </div>
                
                <form id="forgotPasswordForm">
                    <div class="form-group">
                        <label class="form-label">Correo Electrónico</label>
                        <input type="email" class="form-control" id="forgotPasswordEmail" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">Enviar Enlace</button>
                </form>
                
                <div class="auth-footer">
                    <a href="#" class="auth-link" id="backToLogin">Volver al Inicio de Sesión</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Detalles de Inversión -->
    <div class="modal investment-detail-modal" id="investmentDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Detalles de Inversión</div>
                <button class="close-modal" id="closeInvestmentDetailModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="investmentDetailContent">
                <!-- Contenido dinámico de detalles de inversión -->
            </div>
        </div>
    </div>

    <!-- Modal de Puzzle para Mejoras -->
    <div class="modal puzzle-modal" id="puzzleModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">¡Encuentra la Mejora!</div>
                <button class="close-modal" id="closePuzzleModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="text-center">
                <p>Resuelve este puzzle para obtener la mejora:</p>
                <div class="puzzle-grid" id="puzzleGrid">
                    <!-- Aquí se generará el puzzle -->
                </div>
                <p id="puzzleTimer">Tiempo: 10 segundos</p>
                <button class="btn btn-primary mt-3" id="submitPuzzle">
                    <i class="fas fa-check"></i> Resolver
                </button>
            </div>
        </div>
    </div>

    <!-- Diálogo de Confirmación Genérico -->
    <div class="modal confirmation-dialog" id="confirmationDialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="confirmationTitle">Confirmar Acción</div>
                <button class="close-modal" id="closeConfirmationDialog">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="text-center">
                <div class="confirmation-icon warning" id="confirmationIcon">
                    <i class="fas fa-exclamation"></i>
                </div>
                <h3 id="confirmationMessage">¿Estás seguro de que deseas realizar esta acción?</h3>
                <p id="confirmationDescription" class="text-muted">Esta acción no se puede deshacer.</p>
            </div>
            <div class="confirmation-actions">
                <button class="btn btn-outline" id="cancelAction">Cancelar</button>
                <button class="btn btn-primary" id="confirmAction">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAi4QOp1WzDUMx2owRl-cPvF5EvWeD5x10",
            authDomain: "trx-hoy.firebaseapp.com",
            projectId: "trx-hoy",
            storageBucket: "trx-hoy.firebasestorage.app",
            messagingSenderId: "141306706252",
            appId: "1:141306706252:web:385728a8561c51254cf7e9",
            measurementId: "G-BFSFV46P9Q"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Variables globales
        let currentUser = null;
        let userData = null;
        let currentTransactionFilter = 'all';
        let pendingConfirmation = null;
        let earningsInterval = null;
        let adminNotificationsListener = null;
        
        // Variables para el torneo PvP
        let currentTournament = null;
        let tournamentInterval = null;
        let playerPosition = { x: 200, y: 200 };
        let upgrades = [];
        let players = [];
        let minedTRX = 0;
        let hashRate = 10;
        let tournamentTimeLeft = 300; // 5 minutos en segundos
        
        // Elementos del DOM
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const menuToggle = document.getElementById('menuToggle');
        const closeSidebar = document.getElementById('closeSidebar');
        const authContainer = document.getElementById('auth-container');
        const registerModal = document.getElementById('register-modal');
        const loginModal = document.getElementById('login-modal');
        const forgotPasswordModal = document.getElementById('forgot-password-modal');
        const showLogin = document.getElementById('showLogin');
        const showRegister = document.getElementById('showRegister');
        const showForgotPassword = document.getElementById('showForgotPassword');
        const backToLogin = document.getElementById('backToLogin');
        const registerForm = document.getElementById('registerForm');
        const loginForm = document.getElementById('loginForm');
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');
        const logoutBtn = document.getElementById('logoutBtn');
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-links a, .sidebar-menu a[data-page]');
        const copyButtons = document.querySelectorAll('.copy-btn');
        const newInvestmentBtn = document.querySelector('.new-investment-btn');
        const investmentDetailModal = document.getElementById('investmentDetailModal');
        const closeInvestmentDetailModal = document.getElementById('closeInvestmentDetailModal');
        const investmentDetailContent = document.getElementById('investmentDetailContent');
        const confirmationDialog = document.getElementById('confirmationDialog');
        const closeConfirmationDialog = document.getElementById('closeConfirmationDialog');
        const cancelAction = document.getElementById('cancelAction');
        const confirmAction = document.getElementById('confirmAction');
        const confirmationTitle = document.getElementById('confirmationTitle');
        const confirmationMessage = document.getElementById('confirmationMessage');
        const confirmationDescription = document.getElementById('confirmationDescription');
        const confirmationIcon = document.getElementById('confirmationIcon');
        const claimReferralEarningsBtn = document.getElementById('claimReferralEarnings');
        const refreshPageBtn = document.getElementById('refreshPage');
        const lockedBalanceSection = document.getElementById('lockedBalanceSection');
        const lockedBalanceAmount = document.getElementById('lockedBalanceAmount');
        
        // Elementos del torneo PvP
        const joinTournamentButtons = document.querySelectorAll('.join-tournament');
        const activeTournamentSection = document.getElementById('activeTournamentSection');
        const gameMap = document.getElementById('gameMap');
        const moveUpBtn = document.getElementById('moveUp');
        const moveDownBtn = document.getElementById('moveDown');
        const moveLeftBtn = document.getElementById('moveLeft');
        const moveRightBtn = document.getElementById('moveRight');
        const hashRateElement = document.getElementById('hashRate');
        const minedTRXElement = document.getElementById('minedTRX');
        const rankingList = document.getElementById('rankingList');
        const tournamentTimer = document.getElementById('tournamentTimer');
        const puzzleModal = document.getElementById('puzzleModal');
        const closePuzzleModal = document.getElementById('closePuzzleModal');
        const puzzleGrid = document.getElementById('puzzleGrid');
        const submitPuzzle = document.getElementById('submitPuzzle');
        const puzzleTimerElement = document.getElementById('puzzleTimer');
        
        // Filtros de transacciones
        const filterAll = document.getElementById('filterAll');
        const filterDeposits = document.getElementById('filterDeposits');
        const filterWithdrawals = document.getElementById('filterWithdrawals');
        const filterInvestments = document.getElementById('filterInvestments');
        const filterEarnings = document.getElementById('filterEarnings');
        
        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
        
        // Función para inicializar la aplicación
        function initApp() {
            // Configurar event listeners
            setupEventListeners();
            
            // Verificar estado de autenticación
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    initializeUserData();
                    loadUserData();
                    showMainApp();
                    startEarningsTimer();
                    setupAdminNotifications();
                } else {
                    showAuth();
                    stopEarningsTimer();
                    stopAdminNotifications();
                }
            });
        }
        
        // Función para inicializar datos del usuario
        function initializeUserData() {
            if (!currentUser) return;
            
            const userRef = db.collection('users').doc(currentUser.uid);
            
            userRef.get().then(doc => {
                if (!doc.exists) {
                    // Crear documento de usuario con todos los campos necesarios
                    userRef.set({
                        username: currentUser.displayName || currentUser.email.split('@')[0],
                        email: currentUser.email,
                        referralCode: generateReferralCode(),
                        referredBy: null,
                        balance: 10, // BONO DE 10 TRX PARA NUEVOS USUARIOS
                        lockedBalance: 10, // 10 TRX BLOQUEADOS HASTA PRIMERA INVERSIÓN
                        totalEarnings: 0,
                        totalInvested: 0,
                        activeInvestments: 0,
                        totalReferrals: 0,
                        totalCommissions: 0,
                        availableCommissions: 0,
                        referralEarnings: 0,
                        level2Commissions: 0,
                        level3Commissions: 0,
                        lastReferralClaim: null,
                        registrationDate: new Date(),
                        lastLogin: new Date(),
                        welcomeBonusClaimed: true, // Marcar que ya recibió el bono
                        hasMadeFirstInvestment: false, // Para saber si ya realizó la primera inversión
                        hashPoints: 100 // Puntos de hash iniciales para el torneo
                    }).then(() => {
                        // Registrar transacción del bono de bienvenida
                        db.collection('transactions').add({
                            userId: currentUser.uid,
                            type: 'bonus',
                            amount: 10,
                            description: 'Bono de bienvenida de 10 TRX',
                            date: new Date(),
                            status: 'completed'
                        });
                        
                        loadUserData();
                    });
                } else {
                    // Si el usuario ya existe, verificar si ya recibió el bono
                    const userData = doc.data();
                    if (!userData.welcomeBonusClaimed) {
                        // Dar bono de bienvenida a usuarios existentes que no lo hayan recibido
                        userRef.update({
                            balance: (userData.balance || 0) + 10,
                            lockedBalance: (userData.lockedBalance || 0) + 10,
                            welcomeBonusClaimed: true
                        }).then(() => {
                            // Registrar transacción del bono de bienvenida
                            db.collection('transactions').add({
                                userId: currentUser.uid,
                                type: 'bonus',
                                amount: 10,
                                description: 'Bono de bienvenida de 10 TRX',
                                date: new Date(),
                                status: 'completed'
                            });
                            
                            showNotification('¡Has recibido un bono de bienvenida de 10 TRX!', 'success');
                            loadUserData();
                        });
                    }
                }
            }).catch(error => {
                console.error('Error al inicializar datos:', error);
            });
        }
        
        // Configurar event listeners
        function setupEventListeners() {
            // Menú lateral
            menuToggle.addEventListener('click', toggleSidebar);
            closeSidebar.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);
            
            // Navegación entre páginas
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('data-page');
                    if (pageId) {
                        showPage(pageId);
                        if (window.innerWidth <= 768) {
                            toggleSidebar();
                        }
                    }
                });
            });
            
            // Botón de nueva inversión
            newInvestmentBtn.addEventListener('click', function(e) {
                e.preventDefault();
                showPage('invest');
            });
            
            // Botones de copiar
            copyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const targetElement = document.getElementById(targetId);
                    copyToClipboard(targetElement.textContent);
                    showNotification('Copiado al portapapeles', 'success');
                });
            });
            
            // Botón de actualizar página
            refreshPageBtn.addEventListener('click', function() {
                location.reload();
            });
            
            // Autenticación
            showLogin.addEventListener('click', function(e) {
                e.preventDefault();
                showAuthModal('login');
            });
            
            showRegister.addEventListener('click', function(e) {
                e.preventDefault();
                showAuthModal('register');
            });
            
            showForgotPassword.addEventListener('click', function(e) {
                e.preventDefault();
                showAuthModal('forgot-password');
            });
            
            backToLogin.addEventListener('click', function(e) {
                e.preventDefault();
                showAuthModal('login');
            });
            
            registerForm.addEventListener('submit', handleRegister);
            loginForm.addEventListener('submit', handleLogin);
            forgotPasswordForm.addEventListener('submit', handleForgotPassword);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Inversiones
            document.querySelectorAll('[data-plan]').forEach(button => {
                button.addEventListener('click', function() {
                    const plan = this.getAttribute('data-plan');
                    showInvestmentForm(plan);
                });
            });
            
            document.getElementById('investmentAmount').addEventListener('input', updateExpectedEarnings);
            document.getElementById('investForm').addEventListener('submit', handleInvestment);
            
            // Depósitos y retiros
            document.getElementById('submitDeposit').addEventListener('click', handleDeposit);
            document.getElementById('submitWithdraw').addEventListener('click', handleWithdraw);
            
            // Perfil
            document.getElementById('passwordForm').addEventListener('submit', handlePasswordChange);
            
            // Modal de detalles de inversión
            closeInvestmentDetailModal.addEventListener('click', function() {
                investmentDetailModal.classList.remove('active');
            });
            
            // Diálogo de confirmación
            closeConfirmationDialog.addEventListener('click', function() {
                confirmationDialog.classList.remove('active');
                if (pendingConfirmation && pendingConfirmation.reject) {
                    pendingConfirmation.reject();
                }
                pendingConfirmation = null;
            });
            
            cancelAction.addEventListener('click', function() {
                confirmationDialog.classList.remove('active');
                if (pendingConfirmation && pendingConfirmation.reject) {
                    pendingConfirmation.reject();
                }
                pendingConfirmation = null;
            });
            
            confirmAction.addEventListener('click', function() {
                confirmationDialog.classList.remove('active');
                if (pendingConfirmation && pendingConfirmation.resolve) {
                    pendingConfirmation.resolve();
                }
                pendingConfirmation = null;
            });
            
            // Filtros de transacciones
            filterAll.addEventListener('click', function() {
                setTransactionFilter('all');
            });
            
            filterDeposits.addEventListener('click', function() {
                setTransactionFilter('deposit');
            });
            
            filterWithdrawals.addEventListener('click', function() {
                setTransactionFilter('withdrawal');
            });
            
            filterInvestments.addEventListener('click', function() {
                setTransactionFilter('investment');
            });
            
            filterEarnings.addEventListener('click', function() {
                setTransactionFilter('earning');
            });
            
            // Botón para reclamar ganancias por referidos
            claimReferralEarningsBtn.addEventListener('click', handleClaimReferralEarnings);
            
            // Torneo PvP
            joinTournamentButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tournamentSize = parseInt(this.getAttribute('data-size'));
                    joinTournament(tournamentSize);
                });
            });
            
            // Controles de movimiento del juego
            moveUpBtn.addEventListener('click', function() {
                movePlayer(0, -20);
            });
            
            moveDownBtn.addEventListener('click', function() {
                movePlayer(0, 20);
            });
            
            moveLeftBtn.addEventListener('click', function() {
                movePlayer(-20, 0);
            });
            
            moveRightBtn.addEventListener('click', function() {
                movePlayer(20, 0);
            });
            
            // Controles de teclado para movimiento
            document.addEventListener('keydown', function(e) {
                if (!currentTournament) return;
                
                switch(e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        movePlayer(0, -20);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        movePlayer(0, 20);
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        movePlayer(-20, 0);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        movePlayer(20, 0);
                        break;
                }
            });
            
            // Modal de puzzle
            closePuzzleModal.addEventListener('click', function() {
                puzzleModal.classList.remove('active');
            });
            
            submitPuzzle.addEventListener('click', handlePuzzleSubmit);
        }
        
        // Funciones del Torneo PvP
        
        // Unirse a un torneo
        function joinTournament(size) {
            if (!currentUser || !userData) {
                showNotification('Debes iniciar sesión para unirte a un torneo', 'error');
                return;
            }
            
            const entryCost = size * 10; // 10 Hash Points por jugador
            
            if (userData.hashPoints < entryCost) {
                showNotification(`No tienes suficientes Hash Points. Necesitas ${entryCost}`, 'error');
                return;
            }
            
            showConfirmation(
                'Unirse al Torneo',
                `¿Estás seguro de que deseas unirte al torneo de ${size} jugadores?`,
                `Costo de entrada: ${entryCost} Hash Points. Premio: ${size * 10} TRX.`,
                'warning'
            ).then(() => {
                // Crear o unirse a un torneo
                db.collection('tournaments')
                    .where('size', '==', size)
                    .where('status', '==', 'joining')
                    .get()
                    .then(snapshot => {
                        if (!snapshot.empty) {
                            // Unirse a un torneo existente
                            const tournamentDoc = snapshot.docs[0];
                            const tournament = tournamentDoc.data();
                            const tournamentId = tournamentDoc.id;
                            
                            // Verificar si ya está lleno
                            if (tournament.participants.length >= size) {
                                showNotification('Este torneo ya está lleno', 'error');
                                return;
                            }
                            
                            // Agregar usuario al torneo
                            return db.collection('tournaments').doc(tournamentId).update({
                                participants: firebase.firestore.FieldValue.arrayUnion({
                                    userId: currentUser.uid,
                                    username: userData.username,
                                    trxMined: 0,
                                    hashRate: 10
                                })
                            }).then(() => {
                                // Restar Hash Points
                                return db.collection('users').doc(currentUser.uid).update({
                                    hashPoints: userData.hashPoints - entryCost
                                });
                            }).then(() => {
                                currentTournament = {
                                    id: tournamentId,
                                    ...tournament,
                                    participants: [...tournament.participants, {
                                        userId: currentUser.uid,
                                        username: userData.username,
                                        trxMined: 0,
                                        hashRate: 10
                                    }]
                                };
                                
                                // Si el torneo está lleno, iniciarlo
                                if (currentTournament.participants.length >= size) {
                                    startTournament(tournamentId);
                                } else {
                                    showNotification(`Te has unido al torneo. Esperando a ${size - currentTournament.participants.length} jugadores más.`, 'success');
                                }
                            });
                        } else {
                            // Crear nuevo torneo
                            return db.collection('tournaments').add({
                                size: size,
                                status: 'joining',
                                prize: size * 10,
                                entryCost: entryCost,
                                participants: [{
                                    userId: currentUser.uid,
                                    username: userData.username,
                                    trxMined: 0,
                                    hashRate: 10
                                }],
                                createdAt: new Date()
                            }).then(docRef => {
                                // Restar Hash Points
                                return db.collection('users').doc(currentUser.uid).update({
                                    hashPoints: userData.hashPoints - entryCost
                                }).then(() => {
                                    currentTournament = {
                                        id: docRef.id,
                                        size: size,
                                        status: 'joining',
                                        prize: size * 10,
                                        entryCost: entryCost,
                                        participants: [{
                                            userId: currentUser.uid,
                                            username: userData.username,
                                            trxMined: 0,
                                            hashRate: 10
                                        }]
                                    };
                                    
                                    showNotification(`Has creado un nuevo torneo. Esperando a ${size - 1} jugadores más.`, 'success');
                                });
                            });
                        }
                    })
                    .then(() => {
                        loadUserData();
                    })
                    .catch(error => {
                        console.error('Error al unirse al torneo:', error);
                        showNotification('Error al unirse al torneo: ' + error.message, 'error');
                    });
            }).catch(() => {
                // Usuario canceló
            });
        }
        
        // Iniciar torneo
        function startTournament(tournamentId) {
            db.collection('tournaments').doc(tournamentId).update({
                status: 'active',
                startTime: new Date()
            }).then(() => {
                currentTournament.status = 'active';
                showNotification('¡El torneo ha comenzado!', 'success');
                showPage('tournament');
                initializeTournamentGame();
            }).catch(error => {
                console.error('Error al iniciar torneo:', error);
            });
        }
        
        // Inicializar el juego del torneo
        function initializeTournamentGame() {
            if (!currentTournament) return;
            
            // Mostrar sección de torneo activo
            activeTournamentSection.classList.remove('d-none');
            
            // Reiniciar variables del juego
            playerPosition = { x: 200, y: 200 };
            upgrades = [];
            players = currentTournament.participants;
            minedTRX = 0;
            hashRate = 10;
            tournamentTimeLeft = 300; // 5 minutos
            
            // Actualizar UI
            hashRateElement.textContent = hashRate + ' H/s';
            minedTRXElement.textContent = minedTRX;
            updateTournamentTimer();
            
            // Renderizar jugadores
            renderPlayers();
            
            // Generar mejoras iniciales
            generateUpgrades();
            
            // Iniciar intervalos del juego
            startTournamentIntervals();
        }
        
        // Renderizar jugadores en el mapa
        function renderPlayers() {
            gameMap.innerHTML = '';
            
            // Renderizar jugador actual
            const playerElement = document.createElement('div');
            playerElement.className = 'player me';
            playerElement.style.left = playerPosition.x + 'px';
            playerElement.style.top = playerPosition.y + 'px';
            playerElement.style.background = 'linear-gradient(135deg, #ff6b00, #ff8c00)';
            playerElement.innerHTML = '<i class="fas fa-user"></i>';
            gameMap.appendChild(playerElement);
            
            // Renderizar otros jugadores (simulados)
            players.forEach((player, index) => {
                if (player.userId !== currentUser.uid) {
                    const otherPlayer = document.createElement('div');
                    otherPlayer.className = 'player';
                    otherPlayer.style.left = (100 + index * 50) + 'px';
                    otherPlayer.style.top = (100 + index * 50) + 'px';
                    otherPlayer.style.background = 'linear-gradient(135deg, #2196f3, #03a9f4)';
                    otherPlayer.innerHTML = '<i class="fas fa-user"></i>';
                    gameMap.appendChild(otherPlayer);
                }
            });
            
            // Renderizar mejoras
            upgrades.forEach(upgrade => {
                const upgradeElement = document.createElement('div');
                upgradeElement.className = `upgrade ${upgrade.type}`;
                upgradeElement.style.left = upgrade.x + 'px';
                upgradeElement.style.top = upgrade.y + 'px';
                upgradeElement.innerHTML = `<i class="fas fa-${upgrade.icon}"></i>`;
                upgradeElement.addEventListener('click', function() {
                    collectUpgrade(upgrade);
                });
                gameMap.appendChild(upgradeElement);
            });
            
            // Actualizar ranking
            updateRanking();
        }
        
        // Generar mejoras en el mapa
        function generateUpgrades() {
            const upgradeTypes = [
                { type: 'nft', icon: 'gem', multiplier: 2 },
                { type: 'gpu', icon: 'microchip', hashRate: 5 },
                { type: 'energy', icon: 'bolt', bonus: 10 }
            ];
            
            // Generar 3-5 mejoras
            const numUpgrades = Math.floor(Math.random() * 3) + 3;
            
            for (let i = 0; i < numUpgrades; i++) {
                const type = upgradeTypes[Math.floor(Math.random() * upgradeTypes.length)];
                const x = Math.floor(Math.random() * 360) + 20;
                const y = Math.floor(Math.random() * 360) + 20;
                
                upgrades.push({
                    ...type,
                    x: x,
                    y: y,
                    id: Date.now() + i
                });
            }
            
            renderPlayers();
        }
        
        // Mover jugador
        function movePlayer(deltaX, deltaY) {
            if (!currentTournament) return;
            
            // Calcular nueva posición
            const newX = playerPosition.x + deltaX;
            const newY = playerPosition.y + deltaY;
            
            // Verificar límites del mapa
            if (newX >= 20 && newX <= 380 && newY >= 20 && newY <= 380) {
                playerPosition.x = newX;
                playerPosition.y = newY;
                
                // Verificar colisión con mejoras
                checkUpgradeCollision();
                
                renderPlayers();
            }
        }
        
        // Verificar colisión con mejoras
        function checkUpgradeCollision() {
            for (let i = 0; i < upgrades.length; i++) {
                const upgrade = upgrades[i];
                const distance = Math.sqrt(
                    Math.pow(playerPosition.x - upgrade.x, 2) + 
                    Math.pow(playerPosition.y - upgrade.y, 2)
                );
                
                if (distance < 35) { // Radio de colisión
                    // Mostrar puzzle para obtener la mejora
                    showPuzzle(upgrade);
                    upgrades.splice(i, 1);
                    break;
                }
            }
        }
        
        // Mostrar puzzle para obtener mejora
        function showPuzzle(upgrade) {
            // Generar puzzle simple
            puzzleGrid.innerHTML = '';
            const numbers = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            const shuffled = [...numbers].sort(() => Math.random() - 0.5);
            
            shuffled.forEach(num => {
                const piece = document.createElement('div');
                piece.className = 'puzzle-piece';
                piece.textContent = num;
                piece.addEventListener('click', function() {
                    // Resaltar pieza seleccionada
                    document.querySelectorAll('.puzzle-piece').forEach(p => {
                        p.style.background = 'var(--primary)';
                    });
                    this.style.background = 'var(--secondary)';
                    window.selectedPuzzleNumber = num;
                });
                puzzleGrid.appendChild(piece);
            });
            
            // Configurar timer del puzzle
            let puzzleTimeLeft = 10;
            puzzleTimerElement.textContent = `Tiempo: ${puzzleTimeLeft} segundos`;
            
            const puzzleTimer = setInterval(() => {
                puzzleTimeLeft--;
                puzzleTimerElement.textContent = `Tiempo: ${puzzleTimeLeft} segundos`;
                
                if (puzzleTimeLeft <= 0) {
                    clearInterval(puzzleTimer);
                    puzzleModal.classList.remove('active');
                    showNotification('¡Tiempo agotado! Perdiste la mejora.', 'error');
                }
            }, 1000);
            
            // Guardar información de la mejora
            window.currentUpgrade = upgrade;
            window.puzzleTimer = puzzleTimer;
            
            // Mostrar modal
            puzzleModal.classList.add('active');
        }
        
        // Manejar envío de puzzle
        function handlePuzzleSubmit() {
            clearInterval(window.puzzleTimer);
            puzzleModal.classList.remove('active');
            
            if (!window.selectedPuzzleNumber) {
                showNotification('Debes seleccionar un número', 'error');
                return;
            }
            
            // Simular verificación del puzzle (siempre exitosa por ahora)
            applyUpgrade(window.currentUpgrade);
            showNotification(`¡Has obtenido una mejora: ${window.currentUpgrade.type.toUpperCase()}!`, 'success');
            
            // Limpiar variables temporales
            window.selectedPuzzleNumber = null;
            window.currentUpgrade = null;
            window.puzzleTimer = null;
        }
        
        // Aplicar mejora al jugador
        function applyUpgrade(upgrade) {
            switch(upgrade.type) {
                case 'nft':
                    hashRate *= upgrade.multiplier;
                    showNotification(`¡NFT raro encontrado! Hash rate multiplicado x${upgrade.multiplier}`, 'success');
                    break;
                case 'gpu':
                    hashRate += upgrade.hashRate;
                    showNotification(`¡Nueva GPU instalada! +${upgrade.hashRate} H/s`, 'success');
                    break;
                case 'energy':
                    minedTRX += upgrade.bonus;
                    showNotification(`¡Bonus de energía! +${upgrade.bonus} TRX`, 'success');
                    break;
            }
            
            hashRateElement.textContent = hashRate + ' H/s';
            minedTRXElement.textContent = minedTRX;
            
            // Actualizar ranking
            updateRanking();
        }
        
        // Actualizar ranking
        function updateRanking() {
            // Simular datos de otros jugadores
            const rankingData = [
                { username: userData.username, trxMined: minedTRX, isMe: true },
                { username: 'Jugador2', trxMined: Math.floor(Math.random() * 50) + 10, isMe: false },
                { username: 'Jugador3', trxMined: Math.floor(Math.random() * 40) + 5, isMe: false },
                { username: 'Jugador4', trxMined: Math.floor(Math.random() * 30), isMe: false }
            ];
            
            // Ordenar por TRX minado (descendente)
            rankingData.sort((a, b) => b.trxMined - a.trxMined);
            
            // Renderizar ranking
            rankingList.innerHTML = '';
            rankingData.forEach((player, index) => {
                const rankingItem = document.createElement('div');
                rankingItem.className = 'ranking-item';
                
                rankingItem.innerHTML = `
                    <div class="ranking-position ${index < 3 ? 'top3' : ''}">${index + 1}</div>
                    <div class="ranking-details">
                        <div class="ranking-name ${player.isMe ? 'text-primary' : ''}">
                            ${player.username} ${player.isMe ? '(Tú)' : ''}
                        </div>
                        <div class="ranking-trx">${player.trxMined} TRX</div>
                    </div>
                `;
                
                rankingList.appendChild(rankingItem);
            });
        }
        
        // Iniciar intervalos del torneo
        function startTournamentIntervals() {
            // Intervalo para minar TRX
            setInterval(() => {
                if (currentTournament && currentTournament.status === 'active') {
                    minedTRX += hashRate / 10; // 10 H/s = 1 TRX por segundo
                    minedTRXElement.textContent = Math.floor(minedTRX);
                    updateRanking();
                }
            }, 1000);
            
            // Intervalo para el temporizador del torneo
            tournamentInterval = setInterval(() => {
                if (currentTournament && currentTournament.status === 'active') {
                    tournamentTimeLeft--;
                    updateTournamentTimer();
                    
                    if (tournamentTimeLeft <= 0) {
                        endTournament();
                    }
                }
            }, 1000);
            
            // Intervalo para generar nuevas mejoras
            setInterval(() => {
                if (currentTournament && currentTournament.status === 'active' && upgrades.length < 3) {
                    generateUpgrades();
                }
            }, 10000); // Cada 10 segundos
        }
        
        // Actualizar temporizador del torneo
        function updateTournamentTimer() {
            const minutes = Math.floor(tournamentTimeLeft / 60);
            const seconds = tournamentTimeLeft % 60;
            tournamentTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Finalizar torneo
        function endTournament() {
            if (!currentTournament) return;
            
            clearInterval(tournamentInterval);
            
            // Determinar ganador (simulado)
            const winner = userData.username; // Por simplicidad, el usuario actual gana
            
            showConfirmation(
                '¡Torneo Finalizado!',
                `¡Felicidades ${winner}! Has ganado el torneo.`,
                `Has minado ${minedTRX} TRX y ganado ${currentTournament.prize} TRX.`,
                'success'
            ).then(() => {
                // Actualizar balance del usuario
                const newBalance = (userData.balance || 0) + currentTournament.prize;
                
                return db.collection('users').doc(currentUser.uid).update({
                    balance: newBalance
                });
            })
            .then(() => {
                // Registrar transacción de premio
                return db.collection('transactions').add({
                    userId: currentUser.uid,
                    type: 'tournament',
                    amount: currentTournament.prize,
                    description: `Premio del torneo PvP (${currentTournament.size} jugadores)`,
                    date: new Date(),
                    status: 'completed'
                });
            })
            .then(() => {
                // Actualizar estado del torneo
                return db.collection('tournaments').doc(currentTournament.id).update({
                    status: 'finished',
                    winner: currentUser.uid,
                    endTime: new Date()
                });
            })
            .then(() => {
                showNotification(`¡Has ganado ${currentTournament.prize} TRX!`, 'success');
                currentTournament = null;
                activeTournamentSection.classList.add('d-none');
                loadUserData();
            })
            .catch(error => {
                console.error('Error al finalizar torneo:', error);
                showNotification('Error al procesar el premio del torneo', 'error');
            });
        }
        
        // Resto del código existente (las funciones de autenticación, inversiones, etc.)
        // ... (mantener todo el código existente sin cambios)
        
        // Mostrar/ocultar menú lateral
        function toggleSidebar() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }
        
        // Mostrar página específica
        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.add('d-none');
            });
            
            const targetPage = document.getElementById(`${pageId}-page`);
            if (targetPage) {
                targetPage.classList.remove('d-none');
                targetPage.classList.add('fade-in');
                
                // Cargar datos específicos de la página si es necesario
                if (pageId === 'dashboard') {
                    loadDashboardData();
                } else if (pageId === 'invest') {
                    resetInvestmentForm();
                } else if (pageId === 'deposit') {
                    loadDeposits();
                } else if (pageId === 'withdraw') {
                    loadWithdrawals();
                    updateAvailableBalance();
                } else if (pageId === 'referrals') {
                    loadReferralsData();
                } else if (pageId === 'tournament') {
                    // No es necesario cargar datos adicionales por ahora
                } else if (pageId === 'history') {
                    loadTransactionHistory();
                } else if (pageId === 'profile') {
                    loadProfileData();
                }
            }
        }
        
        // Mostrar interfaz de autenticación
        function showAuth() {
            authContainer.classList.remove('d-none');
            document.querySelector('.main-content').classList.add('d-none');
            document.querySelector('header').classList.add('d-none');
            showAuthModal('register');
        }
        
        // Mostrar aplicación principal
        function showMainApp() {
            authContainer.classList.add('d-none');
            document.querySelector('.main-content').classList.remove('d-none');
            document.querySelector('header').classList.remove('d-none');
            showPage('dashboard');
        }
        
        // Mostrar modal de autenticación específico
        function showAuthModal(modal) {
            registerModal.classList.add('d-none');
            loginModal.classList.add('d-none');
            forgotPasswordModal.classList.add('d-none');
            
            if (modal === 'register') {
                registerModal.classList.remove('d-none');
            } else if (modal === 'login') {
                loginModal.classList.remove('d-none');
            } else if (modal === 'forgot-password') {
                forgotPasswordModal.classList.remove('d-none');
            }
        }
        
        // Sistema de notificaciones moderno
        function showNotification(message, type = 'info', title = null) {
            const notificationContainer = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let iconClass = 'fas fa-info-circle';
            if (type === 'success') iconClass = 'fas fa-check-circle';
            if (type === 'error') iconClass = 'fas fa-exclamation-circle';
            if (type === 'warning') iconClass = 'fas fa-exclamation-triangle';
            
            const notificationTitle = title || 
                (type === 'success' ? 'Éxito' : 
                 type === 'error' ? 'Error' : 
                 type === 'warning' ? 'Advertencia' : 'Información');
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="${iconClass}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${notificationTitle}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Animar entrada
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Configurar cierre
            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.addEventListener('click', () => {
                notification.classList.remove('show');
                notification.classList.add('hide');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            });
            
            // Auto cerrar después de 5 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.classList.remove('show');
                    notification.classList.add('hide');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);
        }
        
        // Sistema de diálogos de confirmación
        function showConfirmation(title, message, description = '', type = 'warning') {
            return new Promise((resolve, reject) => {
                confirmationTitle.textContent = title;
                confirmationMessage.textContent = message;
                confirmationDescription.textContent = description;
                
                // Configurar icono según el tipo
                confirmationIcon.className = 'confirmation-icon';
                let iconClass = 'fas fa-exclamation';
                
                if (type === 'danger') {
                    confirmationIcon.classList.add('danger');
                    iconClass = 'fas fa-exclamation-triangle';
                } else if (type === 'success') {
                    confirmationIcon.classList.add('success');
                    iconClass = 'fas fa-check';
                } else {
                    confirmationIcon.classList.add('warning');
                }
                
                confirmationIcon.innerHTML = `<i class="${iconClass}"></i>`;
                
                // Mostrar diálogo
                confirmationDialog.classList.add('active');
                
                // Guardar callbacks
                pendingConfirmation = { resolve, reject };
            });
        }
        
        // Manejar registro de usuario
        function handleRegister(e) {
            e.preventDefault();
            
            const username = document.getElementById('registerUsername').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const referralCode = document.getElementById('registerReferralCode').value;
            
            if (password !== confirmPassword) {
                showNotification('Las contraseñas no coinciden', 'error');
                return;
            }
            
            if (!referralCode) {
                showNotification('El código de referido es obligatorio', 'error');
                return;
            }
            
            // Crear usuario en Firebase Auth
            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    
                    // Generar código de referido único
                    const userReferralCode = generateReferralCode();
                    
                    // Crear documento de usuario en Firestore
                    return db.collection('users').doc(user.uid).set({
                        username: username,
                        email: email,
                        referralCode: userReferralCode,
                        referredBy: referralCode || null,
                        balance: 10, // BONO DE 10 TRX PARA NUEVOS USUARIOS
                        lockedBalance: 10, // 10 TRX BLOQUEADOS HASTA PRIMERA INVERSIÓN
                        totalEarnings: 0,
                        totalInvested: 0,
                        activeInvestments: 0,
                        totalReferrals: 0,
                        totalCommissions: 0,
                        availableCommissions: 0,
                        referralEarnings: 0,
                        level2Commissions: 0,
                        level3Commissions: 0,
                        lastReferralClaim: null,
                        registrationDate: new Date(),
                        lastLogin: new Date(),
                        welcomeBonusClaimed: true, // Marcar que ya recibió el bono
                        hasMadeFirstInvestment: false, // Para saber si ya realizó la primera inversión
                        hashPoints: 100 // Puntos de hash iniciales para el torneo
                    });
                })
                .then(() => {
                    // Registrar transacción del bono de bienvenida
                    return db.collection('transactions').add({
                        userId: currentUser.uid,
                        type: 'bonus',
                        amount: 10,
                        description: 'Bono de bienvenida de 10 TRX',
                        date: new Date(),
                        status: 'completed'
                    });
                })
                .then(() => {
                    // Distribuir comisiones por referidos (0.1 TRX por cada referido)
                    distributeReferralCommissions(referralCode, 0.1, 'Nivel 1: 0.1 TRX por referido directo');
                    
                    showNotification('Cuenta creada exitosamente. ¡Has recibido un bono de 10 TRX!', 'success');
                    showAuthModal('login');
                })
                .catch((error) => {
                    console.error('Error al registrar:', error);
                    showNotification('Error al crear la cuenta: ' + error.message, 'error');
                });
        }
        
        // Distribuir comisiones por referidos en 3 niveles
        function distributeReferralCommissions(referralCode, amount, description, level = 1) {
            if (level > 3) return; // Solo hasta 3 niveles
            
            // Buscar al usuario que refirió
            db.collection('users')
                .where('referralCode', '==', referralCode)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) return;
                    
                    const referrerDoc = snapshot.docs[0];
                    const referrerData = referrerDoc.data();
                    const referrerId = referrerDoc.id;
                    
                    // Calcular comisión según el nivel
                    let commissionAmount = 0;
                    let commissionType = '';
                    
                    if (level === 1) {
                        commissionAmount = amount; // 0.1 TRX por referido directo
                        commissionType = 'referral_bonus';
                    } else if (level === 2) {
                        commissionAmount = amount * 0.05; // 5% para nivel 2
                        commissionType = 'level2_commission';
                    } else if (level === 3) {
                        commissionAmount = amount * 0.02; // 2% para nivel 3
                        commissionType = 'level3_commission';
                    }
                    
                    if (commissionAmount <= 0) return;
                    
                    // Actualizar comisiones del referidor
                    const updateData = {};
                    
                    if (level === 1) {
                        updateData.referralEarnings = (referrerData.referralEarnings || 0) + commissionAmount;
                        updateData.totalReferrals = (referrerData.totalReferrals || 0) + 1;
                    } else if (level === 2) {
                        updateData.level2Commissions = (referrerData.level2Commissions || 0) + commissionAmount;
                    } else if (level === 3) {
                        updateData.level3Commissions = (referrerData.level3Commissions || 0) + commissionAmount;
                    }
                    
                    updateData.totalCommissions = (referrerData.totalCommissions || 0) + commissionAmount;
                    updateData.availableCommissions = (referrerData.availableCommissions || 0) + commissionAmount;
                    
                    return db.collection('users').doc(referrerId).update(updateData);
                })
                .then(() => {
                    // Si hay un referido en el nivel superior, continuar con la distribución
                    if (level < 3 && referrerData.referredBy) {
                        distributeReferralCommissions(referrerData.referredBy, amount, description, level + 1);
                    }
                })
                .catch(error => {
                    console.error('Error al distribuir comisiones:', error);
                });
        }
        
        // Manejar inicio de sesión
        function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Actualizar última fecha de inicio de sesión
                    return db.collection('users').doc(userCredential.user.uid).update({
                        lastLogin: new Date()
                    });
                })
                .catch((error) => {
                    console.error('Error al iniciar sesión:', error);
                    showNotification('Error al iniciar sesión: ' + error.message, 'error');
                });
        }
        
        // Manejar recuperación de contraseña
        function handleForgotPassword(e) {
            e.preventDefault();
            
            const email = document.getElementById('forgotPasswordEmail').value;
            
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    showNotification('Se ha enviado un enlace de recuperación a tu correo', 'success');
                    showAuthModal('login');
                })
                .catch((error) => {
                    console.error('Error al enviar correo de recuperación:', error);
                    showNotification('Error: ' + error.message, 'error');
                });
        }
        
        // Manejar cierre de sesión
        function handleLogout() {
            showConfirmation(
                'Cerrar Sesión', 
                '¿Estás seguro de que deseas cerrar sesión?',
                'Serás redirigido a la página de inicio de sesión.',
                'warning'
            ).then(() => {
                auth.signOut()
                    .then(() => {
                        currentUser = null;
                        userData = null;
                        showNotification('Sesión cerrada correctamente', 'info');
                    })
                    .catch((error) => {
                        console.error('Error al cerrar sesión:', error);
                        showNotification('Error al cerrar sesión', 'error');
                    });
            }).catch(() => {
                // Usuario canceló
            });
        }
        
        // Cargar datos del usuario
        function loadUserData() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        userData = doc.data();
                        updateUIWithUserData();
                    }
                })
                .catch(error => {
                    console.error('Error al cargar datos del usuario:', error);
                    showNotification('Error al cargar datos del usuario', 'error');
                    // Crear datos por defecto si no existen
                    initializeUserData();
                });
        }
        
        // Actualizar UI con datos del usuario
        function updateUIWithUserData() {
            if (!userData) return;
            
            // Actualizar información del usuario en el header
            document.getElementById('userName').textContent = userData.username;
            
            // Actualizar dashboard
            document.getElementById('totalBalance').textContent = (userData.balance || 0) + ' TRX';
            document.getElementById('totalEarnings').textContent = (userData.totalEarnings || 0) + ' TRX';
            document.getElementById('activeInvestments').textContent = userData.activeInvestments || 0;
            document.getElementById('totalReferrals').textContent = userData.totalReferrals || 0;
        }
        
        // Cargar datos del dashboard
        function loadDashboardData() {
            if (!currentUser) return;
            
            // Cargar inversiones activas
            db.collection('investments')
                .where('userId', '==', currentUser.uid)
                .where('status', '==', 'active')
                .get()
                .then(snapshot => {
                    const investmentsContainer = document.getElementById('activeInvestmentsContainer');
                    investmentsContainer.innerHTML = '';
                    
                    if (snapshot.empty) {
                        investmentsContainer.innerHTML = '<div class="text-center"><p>No tienes inversiones activas</p></div>';
                        return;
                    }
                    
                    // Actualizar contador de inversiones activas
                    document.getElementById('activeInvestments').textContent = snapshot.size;
                    
                    snapshot.forEach(doc => {
                        const investment = doc.data();
                        const investmentCard = createInvestmentCard(doc.id, investment);
                        investmentsContainer.appendChild(investmentCard);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar inversiones:', error);
                    document.getElementById('activeInvestmentsContainer').innerHTML = '<div class="text-center"><p>Error al cargar inversiones</p></div>';
                });
        }
        
        // Crear tarjeta de inversión moderna
        function createInvestmentCard(id, investment) {
            const card = document.createElement('div');
            card.className = 'investment-card';
            
            // Calcular días transcurridos y restantes
            const startDate = investment.startDate.toDate();
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + 15);
            const today = new Date();
            const daysPassed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
            const daysRemaining = Math.max(0, 15 - daysPassed);
            
            // Calcular ganancias acumuladas y disponibles
            const dailyEarnings = investment.amount * 0.03;
            const totalEarned = dailyEarnings * daysPassed;
            const availableEarnings = calculateAvailableEarnings(investment);
            
            card.innerHTML = `
                <div class="investment-header">
                    <div class="investment-title">Inversión #${id.substring(0, 8)}</div>
                    <span class="investment-plan">${investment.plan}</span>
                </div>
                
                <div class="investment-details">
                    <div class="investment-detail">
                        <div class="investment-detail-label">Monto Invertido</div>
                        <div class="investment-detail-value">${investment.amount} TRX</div>
                    </div>
                    <div class="investment-detail">
                        <div class="investment-detail-label">Ganancias Acumuladas</div>
                        <div class="investment-detail-value">${totalEarned.toFixed(2)} TRX</div>
                    </div>
                    <div class="investment-detail">
                        <div class="investment-detail-label">Ganancias Disponibles</div>
                        <div class="investment-detail-value">${availableEarnings.toFixed(2)} TRX</div>
                    </div>
                </div>
                
                <!-- Pico de piedra con contador de días -->
                <div class="rock-peak">
                    <div class="rock-icon">
                        <i class="fas fa-mountain"></i>
                    </div>
                    <div class="day-counter">
                        ${daysRemaining} días restantes
                    </div>
                </div>
                
                <div class="investment-actions">
                    <button class="btn btn-primary btn-small claim-earnings-btn" data-id="${id}">
                        <i class="fas fa-coins"></i> Reclamar Ganancias
                    </button>
                    <button class="btn btn-outline btn-small investment-details-btn" data-id="${id}">
                        <i class="fas fa-info-circle"></i> Detalles
                    </button>
                </div>
            `;
            
            // Agregar event listeners a los botones
            const claimBtn = card.querySelector('.claim-earnings-btn');
            claimBtn.addEventListener('click', function() {
                handleClaimEarnings(this.getAttribute('data-id'));
            });
            
            const detailsBtn = card.querySelector('.investment-details-btn');
            detailsBtn.addEventListener('click', function() {
                showInvestmentDetails(this.getAttribute('data-id'));
            });
            
            // Deshabilitar botón si no hay ganancias disponibles
            if (availableEarnings <= 0) {
                claimBtn.classList.add('btn-disabled');
                claimBtn.disabled = true;
            }
            
            return card;
        }
        
        // Mostrar detalles de inversión en modal
        function showInvestmentDetails(investmentId) {
            if (!currentUser) return;
            
            db.collection('investments').doc(investmentId).get()
                .then(doc => {
                    if (!doc.exists) {
                        showNotification('Inversión no encontrada', 'error');
                        return;
                    }
                    
                    const investment = doc.data();
                    
                    // Calcular información detallada
                    const startDate = investment.startDate.toDate();
                    const endDate = new Date(startDate);
                    endDate.setDate(endDate.getDate() + 15);
                    const today = new Date();
                    const daysPassed = Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
                    const daysRemaining = Math.max(0, 15 - daysPassed);
                    
                    const dailyEarnings = investment.amount * 0.03;
                    const totalEarned = dailyEarnings * daysPassed;
                    const totalExpected = investment.amount * 1.45; // 45% de ganancia
                    
                    // Crear contenido del modal
                    investmentDetailContent.innerHTML = `
                        <div class="investment-info">
                            <div class="info-item">
                                <div class="info-label">ID de Inversión</div>
                                <div class="info-value">${investmentId.substring(0, 8)}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Plan</div>
                                <div class="info-value">${investment.plan}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Monto Invertido</div>
                                <div class="info-value">${investment.amount} TRX</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Fecha de Inicio</div>
                                <div class="info-value">${formatDateTime(startDate)}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Fecha de Finalización</div>
                                <div class="info-value">${formatDateTime(endDate)}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Días Transcurridos</div>
                                <div class="info-value">${daysPassed} de 15</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Días Restantes</div>
                                <div class="info-value">${daysRemaining}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Ganancias Diarias</div>
                                <div class="info-value">${dailyEarnings.toFixed(2)} TRX</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Ganancias Acumuladas</div>
                                <div class="info-value">${totalEarned.toFixed(2)} TRX</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Ganancias Totales Esperadas</div>
                                <div class="info-value">${totalExpected.toFixed(2)} TRX</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Retorno Total Esperado</div>
                                <div class="info-value">45%</div>
                            </div>
                        </div>
                        
                        <!-- Pico de piedra con contador de días -->
                        <div class="rock-peak">
                            <div class="rock-icon">
                                <i class="fas fa-mountain"></i>
                            </div>
                            <div class="day-counter">
                                ${daysRemaining} días restantes
                            </div>
                        </div>
                        
                        <div class="text-center mt-3">
                            <p class="text-muted">Esta inversión generará ganancias diarias durante 15 días.</p>
                        </div>
                    `;
                    
                    // Mostrar modal
                    investmentDetailModal.classList.add('active');
                })
                .catch(error => {
                    console.error('Error al cargar detalles de inversión:', error);
                    showNotification('Error al cargar detalles de la inversión', 'error');
                });
        }
        
        // Calcular ganancias disponibles para reclamar
        function calculateAvailableEarnings(investment) {
            // En una implementación real, esto calcularía las ganancias disponibles
            // basándose en el último reclamo y el tiempo transcurrido
            const lastClaim = investment.lastClaim ? investment.lastClaim.toDate() : investment.startDate.toDate();
            const now = new Date();
            const secondsSinceLastClaim = (now - lastClaim) / 1000;
            
            // Permitir reclamar cada 10 segundos
            if (secondsSinceLastClaim < 10) {
                return 0;
            }
            
            // Calcular ganancias desde el último reclamo
            const dailyEarnings = investment.amount * 0.03;
            const secondsInDay = 24 * 60 * 60;
            const earningsPerSecond = dailyEarnings / secondsInDay;
            return earningsPerSecond * Math.floor(secondsSinceLastClaim);
        }
        
        // Manejar reclamo de ganancias
        function handleClaimEarnings(investmentId) {
            if (!currentUser || !userData) return;
            
            db.collection('investments').doc(investmentId).get()
                .then(doc => {
                    if (!doc.exists) {
                        showNotification('Inversión no encontrada', 'error');
                        return;
                    }
                    
                    const investment = doc.data();
                    const availableEarnings = calculateAvailableEarnings(investment);
                    
                    if (availableEarnings <= 0) {
                        showNotification('No hay ganancias disponibles para reclamar en este momento', 'warning');
                        return;
                    }
                    
                    // Mostrar confirmación
                    showConfirmation(
                        'Reclamar Ganancias',
                        `¿Estás seguro de que deseas reclamar ${availableEarnings.toFixed(2)} TRX?`,
                        'Las ganancias se agregarán a tu balance disponible.',
                        'success'
                    ).then(() => {
                        // Actualizar inversión con nuevo lastClaim
                        return db.collection('investments').doc(investmentId).update({
                            lastClaim: new Date(),
                            totalEarned: (investment.totalEarned || 0) + availableEarnings
                        });
                    })
                    .then(() => {
                        // Actualizar balance del usuario
                        const newBalance = (userData.balance || 0) + availableEarnings;
                        const newTotalEarnings = (userData.totalEarnings || 0) + availableEarnings;
                        
                        return db.collection('users').doc(currentUser.uid).update({
                            balance: newBalance,
                            totalEarnings: newTotalEarnings
                        });
                    })
                    .then(() => {
                        // Registrar transacción de ganancias
                        return db.collection('transactions').add({
                            userId: currentUser.uid,
                            type: 'earning',
                            amount: availableEarnings,
                            description: `Ganancias de inversión reclamadas`,
                            date: new Date(),
                            status: 'completed'
                        });
                    })
                    .then(() => {
                        showNotification(`Ganancias de ${availableEarnings.toFixed(2)} TRX reclamadas exitosamente`, 'success');
                        loadUserData();
                        loadDashboardData();
                    })
                    .catch(error => {
                        console.error('Error al reclamar ganancias:', error);
                        showNotification('Error al reclamar ganancias: ' + error.message, 'error');
                    });
                })
                .catch(error => {
                    console.error('Error al cargar inversión:', error);
                    showNotification('Error al cargar información de la inversión', 'error');
                });
        }
        
        // Mostrar formulario de inversión
        function showInvestmentForm(plan) {
            const investmentForm = document.getElementById('investmentForm');
            const selectedPlan = document.getElementById('selectedPlan');
            
            let planName = '';
            let minAmount = 0;
            let maxAmount = 0;
            let dailyPercentage = 3;
            let totalPercentage = 45;
            
            switch(plan) {
                case 'basic':
                    planName = 'Plan Básico';
                    minAmount = 30;
                    maxAmount = 100;
                    dailyPercentage = 3;
                    totalPercentage = 45;
                    break;
                case 'advanced':
                    planName = 'Plan Avanzado';
                    minAmount = 101;
                    maxAmount = 300;
                    dailyPercentage = 3;
                    totalPercentage = 45;
                    break;
                case 'premium':
                    planName = 'Plan Premium';
                    minAmount = 301;
                    maxAmount = 500;
                    dailyPercentage = 3;
                    totalPercentage = 45;
                    break;
                case 'pro':
                    planName = 'Plan Pro';
                    minAmount = 501;
                    maxAmount = 1000;
                    dailyPercentage = 3.5;
                    totalPercentage = 52.5;
                    break;
                case 'vip':
                    planName = 'Plan VIP';
                    minAmount = 1001;
                    maxAmount = 2000;
                    dailyPercentage = 4;
                    totalPercentage = 60;
                    break;
                case 'elite':
                    planName = 'Plan Elite';
                    minAmount = 2001;
                    maxAmount = 5000;
                    dailyPercentage = 5;
                    totalPercentage = 75;
                    break;
            }
            
            selectedPlan.value = planName;
            document.getElementById('investmentAmount').setAttribute('min', minAmount);
            document.getElementById('investmentAmount').setAttribute('max', maxAmount);
            document.getElementById('investmentAmount').value = minAmount;
            document.getElementById('expectedEarningsText').textContent = 
                `${dailyPercentage}% diario durante 15 días (${totalPercentage}% de retorno total).`;
            
            updateExpectedEarnings();
            
            investmentForm.classList.remove('d-none');
            investmentForm.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Resetear formulario de inversión
        function resetInvestmentForm() {
            document.getElementById('investmentForm').classList.add('d-none');
            document.getElementById('investmentAmount').value = '';
            document.getElementById('expectedEarnings').value = '';
        }
        
        // Actualizar ganancias esperadas
        function updateExpectedEarnings() {
            const amount = parseFloat(document.getElementById('investmentAmount').value) || 0;
            const planName = document.getElementById('selectedPlan').value;
            let percentage = 0.45; // Por defecto 45%
            
            if (planName.includes('Pro')) percentage = 0.525;
            if (planName.includes('VIP')) percentage = 0.60;
            if (planName.includes('Elite')) percentage = 0.75;
            
            const expectedEarnings = amount * percentage;
            document.getElementById('expectedEarnings').value = expectedEarnings.toFixed(2) + ' TRX';
        }
        
        // Manejar inversión
        function handleInvestment(e) {
            e.preventDefault();
            
            if (!currentUser || !userData) {
                showNotification('Debes iniciar sesión para invertir', 'error');
                return;
            }
            
            const amount = parseFloat(document.getElementById('investmentAmount').value);
            const plan = document.getElementById('selectedPlan').value;
            
            if (amount < 30 || amount > 5000) {
                showNotification('El monto de inversión debe estar entre 30 y 5000 TRX', 'error');
                return;
            }
            
            if (amount > userData.balance) {
                showNotification('Saldo insuficiente para realizar esta inversión', 'error');
                return;
            }
            
            // Mostrar confirmación
            showConfirmation(
                'Confirmar Inversión',
                `¿Estás seguro de que deseas invertir ${amount} TRX en el ${plan}?`,
                'El monto se descontará de tu balance y la inversión comenzará inmediatamente.',
                'warning'
            ).then(() => {
                // Crear inversión en Firestore
                return db.collection('investments').add({
                    userId: currentUser.uid,
                    amount: amount,
                    plan: plan,
                    startDate: new Date(),
                    endDate: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000), // 15 días
                    status: 'active',
                    earned: 0,
                    lastClaim: new Date()
                });
            })
            .then(() => {
                // Actualizar saldo del usuario y contador de inversiones activas
                const newBalance = userData.balance - amount;
                const newTotalInvested = (userData.totalInvested || 0) + amount;
                const newActiveInvestments = (userData.activeInvestments || 0) + 1;
                
                // Si es la primera inversión del usuario, desbloquear los 10 TRX bloqueados
                let updateData = {
                    balance: newBalance,
                    totalInvested: newTotalInvested,
                    activeInvestments: newActiveInvestments
                };
                
                if (!userData.hasMadeFirstInvestment) {
                    updateData.hasMadeFirstInvestment = true;
                    updateData.lockedBalance = 0;
                    // Mostrar notificación sobre el desbloqueo
                    showNotification('¡Felicidades! Has realizado tu primera inversión. Los 10 TRX bloqueados ahora están disponibles para retiro.', 'success');
                }
                
                return db.collection('users').doc(currentUser.uid).update(updateData);
            })
            .then(() => {
                // Registrar transacción de inversión
                return db.collection('transactions').add({
                    userId: currentUser.uid,
                    type: 'investment',
                    amount: amount,
                    description: `Inversión en ${plan}`,
                    date: new Date(),
                    status: 'completed'
                });
            })
            .then(() => {
                // Distribuir comisiones por referidos en 3 niveles
                if (userData.referredBy) {
                    distributeInvestmentCommissions(userData.referredBy, amount, 'Nivel 1: 10% de comisión por inversión de referido directo');
                }
                
                showNotification('Inversión realizada exitosamente', 'success');
                resetInvestmentForm();
                loadUserData();
                loadDashboardData();
            })
            .catch(error => {
                console.error('Error al realizar inversión:', error);
                showNotification('Error al realizar la inversión: ' + error.message, 'error');
            });
        }
        
        // Distribuir comisiones por inversiones en 3 niveles
        function distributeInvestmentCommissions(referralCode, amount, description, level = 1) {
            if (level > 3) return; // Solo hasta 3 niveles
            
            // Buscar al usuario que refirió
            db.collection('users')
                .where('referralCode', '==', referralCode)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) return;
                    
                    const referrerDoc = snapshot.docs[0];
                    const referrerData = referrerDoc.data();
                    const referrerId = referrerDoc.id;
                    
                    // Calcular comisión según el nivel
                    let commissionAmount = 0;
                    let commissionType = '';
                    
                    if (level === 1) {
                        commissionAmount = amount * 0.10; // 10% para nivel 1
                        commissionType = 'level1_commission';
                    } else if (level === 2) {
                        commissionAmount = amount * 0.05; // 5% para nivel 2
                        commissionType = 'level2_commission';
                    } else if (level === 3) {
                        commissionAmount = amount * 0.02; // 2% para nivel 3
                        commissionType = 'level3_commission';
                    }
                    
                    if (commissionAmount <= 0) return;
                    
                    // Actualizar comisiones del referidor
                    const updateData = {};
                    
                    if (level === 1) {
                        updateData.totalCommissions = (referrerData.totalCommissions || 0) + commissionAmount;
                        updateData.availableCommissions = (referrerData.availableCommissions || 0) + commissionAmount;
                    } else if (level === 2) {
                        updateData.level2Commissions = (referrerData.level2Commissions || 0) + commissionAmount;
                        updateData.totalCommissions = (referrerData.totalCommissions || 0) + commissionAmount;
                        updateData.availableCommissions = (referrerData.availableCommissions || 0) + commissionAmount;
                    } else if (level === 3) {
                        updateData.level3Commissions = (referrerData.level3Commissions || 0) + commissionAmount;
                        updateData.totalCommissions = (referrerData.totalCommissions || 0) + commissionAmount;
                        updateData.availableCommissions = (referrerData.availableCommissions || 0) + commissionAmount;
                    }
                    
                    return db.collection('users').doc(referrerId).update(updateData);
                })
                .then(() => {
                    // Registrar transacción de comisión
                    return db.collection('transactions').add({
                        userId: referrerId,
                        type: 'commission',
                        amount: commissionAmount,
                        description: `${description} - ${commissionAmount.toFixed(2)} TRX`,
                        date: new Date(),
                        status: 'completed'
                    });
                })
                .then(() => {
                    // Si hay un referido en el nivel superior, continuar con la distribución
                    if (level < 3 && referrerData.referredBy) {
                        distributeInvestmentCommissions(referrerData.referredBy, amount, `Nivel ${level + 1}: ${level === 1 ? '5%' : '2%'} de comisión por inversión`, level + 1);
                    }
                })
                .catch(error => {
                    console.error('Error al distribuir comisiones:', error);
                });
        }
        
        // Manejar depósito
        function handleDeposit() {
            if (!currentUser) return;
            
            const amount = parseFloat(document.getElementById('depositAmount').value);
            const transactionHash = document.getElementById('transactionHash').value;
            
            if (amount < 10) {
                showNotification('El depósito mínimo es de 10 TRX', 'error');
                return;
            }
            
            // Mostrar confirmación
            showConfirmation(
                'Solicitar Depósito',
                `¿Estás seguro de que deseas solicitar un depósito de ${amount} TRX?`,
                'El depósito será procesado manualmente. Asegúrate de enviar el monto exacto a la dirección proporcionada.',
                'info'
            ).then(() => {
                // Crear solicitud de depósito
                return db.collection('deposits').add({
                    userId: currentUser.uid,
                    amount: amount,
                    transactionHash: transactionHash || '',
                    status: 'pending',
                    date: new Date()
                });
            })
            .then(() => {
                // Registrar transacción de depósito
                return db.collection('transactions').add({
                    userId: currentUser.uid,
                    type: 'deposit',
                    amount: amount,
                    description: `Depósito de ${amount} TRX`,
                    date: new Date(),
                    status: 'pending',
                    transactionHash: transactionHash || ''
                });
            })
            .then(() => {
                showNotification('Solicitud de depósito enviada. Será procesada manualmente.', 'success');
                document.getElementById('depositAmount').value = '';
                document.getElementById('transactionHash').value = '';
                loadDeposits();
            })
            .catch(error => {
                console.error('Error al solicitar depósito:', error);
                showNotification('Error al solicitar depósito: ' + error.message, 'error');
            });
        }
        
        // Cargar historial de depósitos (VERSIÓN CORREGIDA - SIN ÍNDICES COMPUESTOS)
        function loadDeposits() {
            if (!currentUser) return;
            
            const depositsTable = document.getElementById('depositsTable');
            if (!depositsTable) return;
            
            depositsTable.innerHTML = '<tr><td colspan="4" class="text-center">Cargando depósitos...</td></tr>';
            
            // Consulta simple sin ordenamiento para evitar índices compuestos
            db.collection('deposits')
                .where('userId', '==', currentUser.uid)
                .get()
                .then(snapshot => {
                    depositsTable.innerHTML = '';
                    
                    if (snapshot.empty) {
                        depositsTable.innerHTML = '<tr><td colspan="4" class="text-center">No hay depósitos registrados</td></tr>';
                        return;
                    }
                    
                    // Convertir a array y ordenar localmente
                    const deposits = [];
                    snapshot.forEach(doc => {
                        deposits.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Ordenar por fecha (más reciente primero)
                    deposits.sort((a, b) => {
                        const dateA = a.date ? a.date.toDate() : new Date(0);
                        const dateB = b.date ? b.date.toDate() : new Date(0);
                        return dateB - dateA;
                    });
                    
                    deposits.forEach(deposit => {
                        const row = document.createElement('tr');
                        
                        let statusClass = 'pending';
                        let statusText = 'Pendiente';
                        
                        if (deposit.status === 'completed') {
                            statusClass = 'completed';
                            statusText = 'Completado';
                        } else if (deposit.status === 'rejected') {
                            statusClass = 'cancelled';
                            statusText = 'Rechazado';
                        }
                        
                        // Manejar fechas de forma segura
                        let dateString = 'Fecha no disponible';
                        if (deposit.date && deposit.date.toDate) {
                            try {
                                dateString = formatDate(deposit.date.toDate());
                            } catch (e) {
                                dateString = 'Fecha inválida';
                            }
                        }
                        
                        row.innerHTML = `
                            <td>${dateString}</td>
                            <td>${deposit.amount || 0} TRX</td>
                            <td>${deposit.transactionHash || 'N/A'}</td>
                            <td><span class="status ${statusClass}">${statusText}</span></td>
                        `;
                        
                        depositsTable.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar depósitos:', error);
                    // Si hay error de índice, intentar con consulta más simple
                    if (error.message.includes('index')) {
                        depositsTable.innerHTML = '<tr><td colspan="4" class="text-center">Configurando base de datos. Intenta nuevamente en unos segundos.</td></tr>';
                        showNotification('La base de datos se está configurando. Por favor, intenta nuevamente en unos momentos.', 'warning');
                    } else {
                        depositsTable.innerHTML = '<tr><td colspan="4" class="text-center">Error al cargar depósitos: ' + error.message + '</td></tr>';
                    }
                });
        }
        
        // Actualizar saldo disponible para retiro
        function updateAvailableBalance() {
            if (!userData) return;
            
            // Calcular saldo disponible (balance total menos balance bloqueado)
            const availableBalance = (userData.balance || 0) - (userData.lockedBalance || 0);
            document.getElementById('availableBalance').value = availableBalance + ' TRX';
            
            // Mostrar u ocultar la sección de balance bloqueado
            if (userData.lockedBalance && userData.lockedBalance > 0) {
                lockedBalanceSection.classList.remove('d-none');
                lockedBalanceAmount.textContent = userData.lockedBalance + ' TRX';
            } else {
                lockedBalanceSection.classList.add('d-none');
            }
        }
        
        // Manejar retiro
        function handleWithdraw() {
            if (!currentUser || !userData) return;
            
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const address = document.getElementById('withdrawAddress').value;
            
            if (amount < 5) {
                showNotification('El retiro mínimo es de 5 TRX', 'error');
                return;
            }
            
            // Calcular saldo disponible (balance total menos balance bloqueado)
            const availableBalance = (userData.balance || 0) - (userData.lockedBalance || 0);
            
            if (amount > availableBalance) {
                if (userData.lockedBalance && userData.lockedBalance > 0) {
                    showNotification(`Saldo insuficiente. Tienes ${userData.lockedBalance} TRX bloqueados que no puedes retirar hasta que realices tu primera inversión.`, 'error');
                } else {
                    showNotification('Saldo insuficiente para realizar este retiro', 'error');
                }
                return;
            }
            
            if (!address) {
                showNotification('Debes ingresar una dirección TRX válida', 'error');
                return;
            }
            
            // Mostrar confirmación
            showConfirmation(
                'Solicitar Retiro',
                `¿Estás seguro de que deseas solicitar un retiro de ${amount} TRX?`,
                `Los fondos se enviarán a la dirección: ${address.substring(0, 10)}...${address.substring(address.length - 10)}. El retiro será procesado dentro de 24 horas.`,
                'warning'
            ).then(() => {
                // Crear solicitud de retiro
                return db.collection('withdrawals').add({
                    userId: currentUser.uid,
                    amount: amount,
                    address: address,
                    status: 'pending',
                    date: new Date()
                });
            })
            .then(() => {
                // Registrar transacción de retiro
                return db.collection('transactions').add({
                    userId: currentUser.uid,
                    type: 'withdrawal',
                    amount: amount,
                    description: `Retiro a dirección ${address.substring(0, 10)}...`,
                    date: new Date(),
                    status: 'pending'
                });
            })
            .then(() => {
                // Actualizar saldo del usuario
                const newBalance = userData.balance - amount;
                return db.collection('users').doc(currentUser.uid).update({
                    balance: newBalance
                });
            })
            .then(() => {
                showNotification('Solicitud de retiro enviada. Será procesada dentro de 24 horas.', 'success');
                document.getElementById('withdrawAmount').value = '';
                document.getElementById('withdrawAddress').value = '';
                updateAvailableBalance();
                loadWithdrawals();
                loadUserData();
            })
            .catch(error => {
                console.error('Error al solicitar retiro:', error);
                showNotification('Error al solicitar retiro: ' + error.message, 'error');
            });
        }
        
        // Cargar historial de retiros (VERSIÓN CORREGIDA - SIN ÍNDICES COMPUESTOS)
        function loadWithdrawals() {
            if (!currentUser) return;
            
            const withdrawalsTable = document.getElementById('withdrawalsTable');
            if (!withdrawalsTable) return;
            
            withdrawalsTable.innerHTML = '<tr><td colspan="4" class="text-center">Cargando retiros...</td></tr>';
            
            // Consulta simple sin ordenamiento para evitar índices compuestos
            db.collection('withdrawals')
                .where('userId', '==', currentUser.uid)
                .get()
                .then(snapshot => {
                    withdrawalsTable.innerHTML = '';
                    
                    if (snapshot.empty) {
                        withdrawalsTable.innerHTML = '<tr><td colspan="4" class="text-center">No hay retiros registrados</td></tr>';
                        return;
                    }
                    
                    // Convertir a array y ordenar localmente
                    const withdrawals = [];
                    snapshot.forEach(doc => {
                        withdrawals.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Ordenar por fecha (más reciente primero)
                    withdrawals.sort((a, b) => {
                        const dateA = a.date ? a.date.toDate() : new Date(0);
                        const dateB = b.date ? b.date.toDate() : new Date(0);
                        return dateB - dateA;
                    });
                    
                    withdrawals.forEach(withdrawal => {
                        const row = document.createElement('tr');
                        
                        let statusClass = 'pending';
                        let statusText = 'Pendiente';
                        
                        if (withdrawal.status === 'completed') {
                            statusClass = 'completed';
                            statusText = 'Completado';
                        } else if (withdrawal.status === 'rejected') {
                            statusClass = 'cancelled';
                            statusText = 'Rechazado';
                        }
                        
                        // Manejar fechas de forma segura
                        let dateString = 'Fecha no disponible';
                        if (withdrawal.date && withdrawal.date.toDate) {
                            try {
                                dateString = formatDate(withdrawal.date.toDate());
                            } catch (e) {
                                dateString = 'Fecha inválida';
                            }
                        }
                        
                        // Acortar dirección para mostrar
                        const address = withdrawal.address || '';
                        const shortAddress = address.length > 20 ? 
                            address.substring(0, 10) + '...' + address.substring(address.length - 10) : 
                            address;
                        
                        row.innerHTML = `
                            <td>${dateString}</td>
                            <td>${withdrawal.amount || 0} TRX</td>
                            <td>${shortAddress || 'N/A'}</td>
                            <td><span class="status ${statusClass}">${statusText}</span></td>
                        `;
                        
                        withdrawalsTable.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar retiros:', error);
                    // Si hay error de índice, intentar con consulta más simple
                    if (error.message.includes('index')) {
                        withdrawalsTable.innerHTML = '<tr><td colspan="4" class="text-center">Configurando base de datos. Intenta nuevamente en unos segundos.</td></tr>';
                        showNotification('La base de datos se está configurando. Por favor, intenta nuevamente en unos momentos.', 'warning');
                    } else {
                        withdrawalsTable.innerHTML = '<tr><td colspan="4" class="text-center">Error al cargar retiros: ' + error.message + '</td></tr>';
                    }
                });
        }
        
        // Cargar datos de referidos - VERSIÓN ACTUALIZADA CON 3 NIVELES
        function loadReferralsData() {
            if (!currentUser || !userData) return;
            
            // Actualizar código de referido
            document.getElementById('referralCode').textContent = userData.referralCode || 'N/A';
            
            // Actualizar enlace del bot de Telegram con el código de referido
            document.getElementById('referralLink').textContent = 'https://t.me/TRXInvestment12_bot?start=' + (userData.referralCode || '');
            
            // Cargar árbol de referidos jerárquico
            loadReferralTree();
            
            // Cargar estadísticas de comisiones
            loadReferralStats();
        }
        
        // Cargar árbol de referidos jerárquico
        function loadReferralTree() {
            if (!currentUser || !userData) return;
            
            const referralTreeContainer = document.getElementById('referralTreeContainer');
            referralTreeContainer.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Cargando tu red de referidos...</p></div>';
            
            // Función recursiva para obtener referidos por niveles
            function getReferralsByLevel(referralCode, level, maxLevels = 3) {
                if (level > maxLevels) return Promise.resolve([]);
                
                return db.collection('users')
                    .where('referredBy', '==', referralCode)
                    .get()
                    .then(snapshot => {
                        if (snapshot.empty) return [];
                        
                        const referrals = [];
                        const promises = [];
                        
                        snapshot.forEach(doc => {
                            const user = {
                                id: doc.id,
                                ...doc.data()
                            };
                            
                            referrals.push({
                                ...user,
                                level: level
                            });
                            
                            // Obtener referidos del siguiente nivel
                            promises.push(
                                getReferralsByLevel(user.referralCode, level + 1, maxLevels)
                                    .then(nextLevelReferrals => {
                                        user.children = nextLevelReferrals;
                                        return user;
                                    })
                            );
                        });
                        
                        return Promise.all(promises).then(() => referrals);
                    })
                    .catch(error => {
                        console.error('Error al cargar referidos del nivel', level, error);
                        return [];
                    });
            }
            
            // Obtener todos los niveles de referidos
            getReferralsByLevel(userData.referralCode, 1, 3)
                .then(allReferrals => {
                    // Procesar y mostrar los referidos por niveles
                    displayReferralTree(allReferrals);
                })
                .catch(error => {
                    console.error('Error al cargar árbol de referidos:', error);
                    referralTreeContainer.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>Error al cargar tu red de referidos</p></div>';
                });
        }
        
        // Mostrar árbol de referidos jerárquico
        function displayReferralTree(referrals) {
            const referralTreeContainer = document.getElementById('referralTreeContainer');
            
            if (!referrals || referrals.length === 0) {
                referralTreeContainer.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>No tienes referidos aún</p><p class="text-muted">Comparte tu código de referido para comenzar a construir tu red</p></div>';
                return;
            }
            
            // Agrupar referidos por nivel
            const referralsByLevel = {};
            let totalReferrals = 0;
            
            function processReferrals(refList, level) {
                if (!refList || refList.length === 0) return;
                
                if (!referralsByLevel[level]) {
                    referralsByLevel[level] = [];
                }
                
                refList.forEach(ref => {
                    referralsByLevel[level].push(ref);
                    totalReferrals++;
                    
                    // Procesar hijos recursivamente
                    if (ref.children && ref.children.length > 0) {
                        processReferrals(ref.children, level + 1);
                    }
                });
            }
            
            processReferrals(referrals, 1);
            
            // Construir HTML del árbol
            let html = '';
            
            // Mostrar total de referidos
            html += `<div class="alert alert-success mb-3"><i class="fas fa-users"></i> Tienes un total de <strong>${totalReferrals}</strong> referidos en tu red</div>`;
            
            // Mostrar cada nivel
            Object.keys(referralsByLevel).sort().forEach(level => {
                const levelReferrals = referralsByLevel[level];
                
                html += `
                    <div class="referral-level">
                        <div class="level-title">
                            <span>Nivel ${level}</span>
                            <span class="level-badge">${levelReferrals.length} referidos</span>
                        </div>
                        <div class="referral-list">
                `;
                
                levelReferrals.forEach(referral => {
                    const registrationDate = referral.registrationDate ? 
                        formatDate(referral.registrationDate.toDate()) : 'N/A';
                    
                    const totalInvested = referral.totalInvested || 0;
                    
                    // Calcular comisión según el nivel
                    let commissionRate = 0;
                    if (level == 1) commissionRate = 0.10; // 10%
                    if (level == 2) commissionRate = 0.05; // 5%
                    if (level == 3) commissionRate = 0.02; // 2%
                    
                    const commission = totalInvested * commissionRate;
                    
                    html += `
                        <div class="referral-item">
                            <div class="referral-user">
                                <div class="referral-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="referral-info">
                                    <div class="referral-name">${referral.username}</div>
                                    <div class="referral-date">Registrado: ${registrationDate}</div>
                                </div>
                            </div>
                            <div class="referral-stats">
                                <div class="stat-item">
                                    <div class="stat-label">Inversión</div>
                                    <div class="stat-value">${totalInvested} TRX</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-label">Tu Ganancia</div>
                                    <div class="stat-value">${commission.toFixed(2)} TRX</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            referralTreeContainer.innerHTML = html;
            
            // Actualizar contador total de referidos
            document.getElementById('totalReferrals').textContent = totalReferrals;
            if (userData) {
                userData.totalReferrals = totalReferrals;
            }
        }
        
        // Cargar estadísticas de referidos
        function loadReferralStats() {
            if (!currentUser || !userData) return;
            
            // Actualizar estadísticas de comisiones
            document.getElementById('totalCommissions').textContent = (userData.totalCommissions || 0).toFixed(2) + ' TRX';
            document.getElementById('availableCommissions').textContent = (userData.availableCommissions || 0).toFixed(2) + ' TRX';
            document.getElementById('referralEarnings').textContent = (userData.referralEarnings || 0).toFixed(2) + ' TRX';
            
            // Calcular comisiones por nivel (Nivel 1 = totalCommissions - (level2Commissions + level3Commissions))
            const level2Commissions = userData.level2Commissions || 0;
            const level3Commissions = userData.level3Commissions || 0;
            const level1Commissions = (userData.totalCommissions || 0) - level2Commissions - level3Commissions;
            
            document.getElementById('level1Commissions').textContent = level1Commissions.toFixed(2) + ' TRX';
            document.getElementById('level2Commissions').textContent = level2Commissions.toFixed(2) + ' TRX';
            document.getElementById('level3Commissions').textContent = level3Commissions.toFixed(2) + ' TRX';
        }
        
        // Manejar reclamo de ganancias por referidos
        function handleClaimReferralEarnings() {
            if (!currentUser || !userData) return;
            
            // Verificar si es día hábil (lunes a viernes)
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = domingo, 1 = lunes, ..., 6 = sábado
            
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                showNotification('Las ganancias por referidos solo se pueden reclamar de lunes a viernes', 'warning');
                return;
            }
            
            // Verificar si ya se reclamó hoy
            if (userData.lastReferralClaim) {
                const lastClaimDate = userData.lastReferralClaim.toDate();
                const timeDiff = today - lastClaimDate;
                const hoursDiff = timeDiff / (1000 * 60 * 60);
                
                if (hoursDiff < 24) {
                    showNotification('Ya has reclamado tus ganancias por referidos hoy. Vuelve mañana.', 'warning');
                    return;
                }
            }
            
            // Calcular ganancias (0.1 TRX por cada referido)
            const referralEarnings = (userData.totalReferrals || 0) * 0.1;
            
            if (referralEarnings <= 0) {
                showNotification('No tienes ganancias por referidos para reclamar', 'warning');
                return;
            }
            
            // Mostrar confirmación
            showConfirmation(
                'Reclamar Ganancias por Referidos',
                `¿Estás seguro de que deseas reclamar ${referralEarnings.toFixed(2)} TRX?`,
                'Esta cantidad corresponde a 0.1 TRX por cada uno de tus referidos.',
                'success'
            ).then(() => {
                // Actualizar balance del usuario
                const newBalance = (userData.balance || 0) + referralEarnings;
                const newTotalEarnings = (userData.totalEarnings || 0) + referralEarnings;
                
                return db.collection('users').doc(currentUser.uid).update({
                    balance: newBalance,
                    totalEarnings: newTotalEarnings,
                    lastReferralClaim: new Date()
                });
            })
            .then(() => {
                // Registrar transacción de ganancias por referidos
                return db.collection('transactions').add({
                    userId: currentUser.uid,
                    type: 'earning',
                    amount: referralEarnings,
                    description: `Ganancias por ${userData.totalReferrals || 0} referidos`,
                    date: new Date(),
                    status: 'completed'
                });
            })
            .then(() => {
                showNotification(`Ganancias por referidos de ${referralEarnings.toFixed(2)} TRX reclamadas exitosamente`, 'success');
                loadUserData();
                loadReferralsData();
            })
            .catch(error => {
                console.error('Error al reclamar ganancias por referidos:', error);
                showNotification('Error al reclamar ganancias por referidos: ' + error.message, 'error');
            });
        }
        
        // Cargar historial de transacciones (VERSIÓN CORREGIDA - SIN ÍNDICES COMPUESTOS)
        function loadTransactionHistory() {
            if (!currentUser) {
                console.log('Usuario no autenticado');
                return;
            }

            const transactionsTable = document.getElementById('transactionsTable');
            if (!transactionsTable) {
                console.log('Tabla de transacciones no encontrada');
                return;
            }
            
            transactionsTable.innerHTML = '<tr><td colspan="5" class="text-center">Cargando transacciones...</td></tr>';
            
            console.log('Cargando transacciones para usuario:', currentUser.uid);
            
            // Consulta simple sin ordenamiento para evitar índices compuestos
            let query = db.collection('transactions')
                .where('userId', '==', currentUser.uid)
                .limit(50); // Limitar para evitar cargas muy grandes

            query.get()
                .then(snapshot => {
                    console.log('Transacciones encontradas:', snapshot.size);
                    transactionsTable.innerHTML = '';
                    
                    if (snapshot.empty) {
                        transactionsTable.innerHTML = '<tr><td colspan="5" class="text-center">No hay transacciones registradas</td></tr>';
                        return;
                    }
                    
                    // Convertir a array y ordenar localmente
                    const transactions = [];
                    snapshot.forEach(doc => {
                        transactions.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Ordenar por fecha (más reciente primero)
                    transactions.sort((a, b) => {
                        const dateA = a.date ? a.date.toDate() : new Date(0);
                        const dateB = b.date ? b.date.toDate() : new Date(0);
                        return dateB - dateA;
                    });
                    
                    // Aplicar filtro si no es "all"
                    let filteredTransactions = transactions;
                    if (currentTransactionFilter !== 'all') {
                        filteredTransactions = transactions.filter(t => t.type === currentTransactionFilter);
                    }
                    
                    filteredTransactions.forEach(transaction => {
                        const row = document.createElement('tr');
                        
                        // Determinar clase CSS para el monto
                        let amountClass = '';
                        let amountPrefix = '';
                        
                        if (transaction.type === 'deposit' || transaction.type === 'earning' || transaction.type === 'bonus' || transaction.type === 'commission') {
                            amountClass = 'transaction-positive';
                            amountPrefix = '+';
                        } else if (transaction.type === 'withdrawal' || transaction.type === 'investment') {
                            amountClass = 'transaction-negative';
                            amountPrefix = '-';
                        }
                        
                        // Determinar icono y clase para el tipo de transacción
                        let typeIcon = '';
                        let typeClass = '';
                        let typeText = '';
                        
                        switch(transaction.type) {
                            case 'deposit':
                                typeIcon = 'fas fa-wallet';
                                typeClass = 'transaction-type deposit';
                                typeText = 'Depósito';
                                break;
                            case 'withdrawal':
                                typeIcon = 'fas fa-money-bill-wave';
                                typeClass = 'transaction-type withdrawal';
                                typeText = 'Retiro';
                                break;
                            case 'investment':
                                typeIcon = 'fas fa-chart-line';
                                typeClass = 'transaction-type investment';
                                typeText = 'Inversión';
                                break;
                            case 'earning':
                                typeIcon = 'fas fa-coins';
                                typeClass = 'transaction-type earning';
                                typeText = 'Ganancia';
                                break;
                            case 'bonus':
                                typeIcon = 'fas fa-gift';
                                typeClass = 'transaction-type earning';
                                typeText = 'Bono';
                                break;
                            case 'commission':
                                typeIcon = 'fas fa-users';
                                typeClass = 'transaction-type earning';
                                typeText = 'Comisión';
                                break;
                            default:
                                typeIcon = 'fas fa-exchange-alt';
                                typeClass = 'transaction-type';
                                typeText = transaction.type || 'Transacción';
                        }
                        
                        let statusClass = 'pending';
                        let statusText = 'Pendiente';
                        
                        if (transaction.status === 'completed') {
                            statusClass = 'completed';
                            statusText = 'Completado';
                        } else if (transaction.status === 'cancelled' || transaction.status === 'rejected') {
                            statusClass = 'cancelled';
                            statusText = 'Cancelado';
                        }
                        
                        // Asegurarse de que la fecha sea válida
                        let dateString = 'Fecha no disponible';
                        if (transaction.date && transaction.date.toDate) {
                            try {
                                dateString = formatDateTime(transaction.date.toDate());
                            } catch (e) {
                                console.error('Error formateando fecha:', e);
                                dateString = 'Fecha inválida';
                            }
                        }
                        
                        row.innerHTML = `
                            <td>${dateString}</td>
                            <td>
                                <span class="${typeClass}">
                                    <i class="${typeIcon}"></i>
                                    ${typeText}
                                </span>
                            </td>
                            <td>${transaction.description || 'Sin descripción'}</td>
                            <td class="${amountClass}">${amountPrefix}${transaction.amount || 0} TRX</td>
                            <td><span class="status ${statusClass}">${statusText}</span></td>
                        `;
                        
                        transactionsTable.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar transacciones:', error);
                    // Si hay error de índice, intentar con consulta más simple
                    if (error.message.includes('index')) {
                        transactionsTable.innerHTML = '<tr><td colspan="5" class="text-center">Configurando base de datos. Intenta nuevamente en unos segundos.</td></tr>';
                        showNotification('La base de datos se está configurando. Por favor, intenta nuevamente en unos momentos.', 'warning');
                    } else {
                        transactionsTable.innerHTML = '<tr><td colspan="5" class="text-center">Error al cargar transacciones: ' + error.message + '</td></tr>';
                    }
                });
        }
        
        // Establecer filtro de transacciones
        function setTransactionFilter(filter) {
            currentTransactionFilter = filter;
            
            // Actualizar estado activo de los botones
            document.querySelectorAll('#history-page .btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
            });
            
            const activeButton = document.getElementById(`filter${filter.charAt(0).toUpperCase() + filter.slice(1)}`);
            if (activeButton) {
                activeButton.classList.remove('btn-outline');
                activeButton.classList.add('btn-primary');
            }
            
            // Recargar transacciones con el filtro aplicado
            loadTransactionHistory();
        }
        
        // Cargar datos del perfil
        function loadProfileData() {
            if (!userData) return;
            
            document.getElementById('profileUsername').value = userData.username || '';
            document.getElementById('profileEmail').value = userData.email || '';
            document.getElementById('profileRegistrationDate').value = userData.registrationDate ? 
                formatDate(userData.registrationDate.toDate()) : 'N/A';
            document.getElementById('profileReferralCode').value = userData.referredBy || '';
        }
        
        // Manejar cambio de contraseña
        function handlePasswordChange(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showNotification('Las nuevas contraseñas no coinciden', 'error');
                return;
            }
            
            // Reautenticar al usuario
            const credential = firebase.auth.EmailAuthProvider.credential(
                currentUser.email, 
                currentPassword
            );
            
            currentUser.reauthenticateWithCredential(credential)
                .then(() => {
                    // Cambiar contraseña
                    return currentUser.updatePassword(newPassword);
                })
                .then(() => {
                    showNotification('Contraseña cambiada exitosamente', 'success');
                    document.getElementById('passwordForm').reset();
                })
                .catch(error => {
                    console.error('Error al cambiar contraseña:', error);
                    showNotification('Error al cambiar contraseña: ' + error.message, 'error');
                });
        }
        
        // Configurar notificaciones en tiempo real desde administración
        function setupAdminNotifications() {
            if (!currentUser) return;
            
            // Escuchar notificaciones globales
            adminNotificationsListener = db.collection('adminNotifications')
                .where('active', '==', true)
                .orderBy('timestamp', 'desc')
                .limit(5)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const notification = change.doc.data();
                            showNotification(
                                notification.message, 
                                notification.type || 'info', 
                                notification.title || 'Notificación del Sistema'
                            );
                        }
                    });
                }, error => {
                    console.error('Error al escuchar notificaciones:', error);
                });
        }
        
        // Detener notificaciones en tiempo real
        function stopAdminNotifications() {
            if (adminNotificationsListener) {
                adminNotificationsListener();
                adminNotificationsListener = null;
            }
        }
        
        // Iniciar temporizador para actualizar ganancias en tiempo real
        function startEarningsTimer() {
            // Actualizar cada 10 segundos
            earningsInterval = setInterval(() => {
                if (currentUser) {
                    updateEarningsInRealTime();
                }
            }, 10000); // 10 segundos
        }
        
        // Detener temporizador de ganancias
        function stopEarningsTimer() {
            if (earningsInterval) {
                clearInterval(earningsInterval);
                earningsInterval = null;
            }
        }
        
        // Actualizar ganancias en tiempo real
        function updateEarningsInRealTime() {
            if (!currentUser) return;
            
            // Actualizar inversiones activas en el dashboard
            if (document.getElementById('dashboard-page') && !document.getElementById('dashboard-page').classList.contains('d-none')) {
                loadDashboardData();
            }
        }
        
        // Utilidades
        
        // Generar código de referido único
        function generateReferralCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        // Formatear fecha
        function formatDate(date) {
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }
        
        // Formatear fecha y hora
        function formatDateTime(date) {
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Copiar al portapapeles
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
    </script>
</body>
</html>
